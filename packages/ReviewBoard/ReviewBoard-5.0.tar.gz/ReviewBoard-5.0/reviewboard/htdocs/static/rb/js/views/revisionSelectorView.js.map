{"version":3,"file":"revisionSelectorView.js","names":["RB","RevisionSelectorView","Backbone","View","extend","template","_","events","initialize","options","console","assert","isObject","numHandles","_activeHandle","_firstLabelActive","firstLabelActive","_mouseActive","_numHandles","_values","_rendered","listenTo","model","_update","bindAll","render","revisionLabels","$el","html","_positions","i","length","push","_$handles","$","_$range","_$ticks","_$labels","_$trough","width","each","label","addClass","css","appendTo","$label","text","data","_updateHandles","positions","values","_activeValues","children","el","_onHandleMouseDown","ev","preventDefault","stopPropagation","currentTarget","document","addEventListener","_onHandleMouseUp","_onHandleMouseMove","removeEventListener","removeClass","isEqual","trigger","mouseX","window","pageXOffset","clientX","offset","left","closestPos","closestDist","dist","Math","abs","undefined","min","max"],"sources":["../../../../../static/rb/js/views/revisionSelectorView.es6.js"],"sourcesContent":["/**\n * An abstract base class for revision selector controls. This is extended by\n * the controls used on the diff viewer and file attachment review UI pages.\n */\nRB.RevisionSelectorView = Backbone.View.extend({\n    template: _.template(dedent`\n        <div class=\"revision-selector\">\n         <div class=\"revision-selector-trough\"></div>\n         <div class=\"revision-selector-range\"></div>\n         <div class=\"revision-selector-ticks\"></div>\n         <div class=\"revision-selector-labels\"></div>\n         <div class=\"revision-selector-handles\"></div>\n        </div>\n    `),\n\n    events: {\n        'mousedown .revision-selector-handle': '_onHandleMouseDown',\n        'mousedown .revision-selector-label': '_onLabelMouseDown',\n        'click .revision-selector-label': '_onLabelClick',\n    },\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     firstLabelActive (boolean):\n     *         Whether the first label should be an active (selectable)\n     *         revision or not.\n     *\n     *     numHandles (number):\n     *         The number of revision slider handles to show.\n     */\n    initialize(options) {\n        console.assert(_.isObject(options));\n        console.assert(options.numHandles === 1 || options.numHandles === 2);\n\n        this._activeHandle = null;\n        this._firstLabelActive = options.firstLabelActive;\n        this._mouseActive = false;\n        this._numHandles = options.numHandles;\n        this._values = [];\n\n        this._rendered = false;\n\n        this.listenTo(this.model, 'change', this._update);\n\n        _.bindAll(this, '_onHandleMouseUp', '_onHandleMouseMove');\n    },\n\n    /**\n     * Render the view.\n     *\n     * Args:\n     *     revisionLabels (Array):\n     *         The labels to use for each revision.\n     *\n     * Returns:\n     *     RB.RevisionSelectorView:\n     *     This object, for chaining.\n     */\n    render(revisionLabels) {\n        this.$el.html(this.template());\n\n        this._positions = [];\n\n        let i;\n\n        for (i = 0; i < revisionLabels.length; i++) {\n            // Ticks are spaced 30px apart.\n            this._positions.push(i * 30);\n        }\n\n        this._$handles = this.$('.revision-selector-handles');\n        this._$range = this.$('.revision-selector-range');\n        this._$ticks = this.$('.revision-selector-ticks');\n        this._$labels = this.$('.revision-selector-labels');\n        this._$trough = this.$('.revision-selector-trough')\n            .width(this._positions[i - 1]);\n\n        _.each(revisionLabels, (label, i) => {\n            $('<div/>')\n                .addClass('revision-selector-tick')\n                .css('left', this._positions[i] + 'px')\n                .appendTo(this._$ticks);\n\n            const $label = $('<div/>')\n                .text(label)\n                .addClass('revision-selector-label')\n                .appendTo(this._$labels);\n\n            $label.css('left', (this._positions[i] -\n                                ($label.width() / 2)) + 'px');\n\n            if (this._firstLabelActive || i > 0) {\n                $label\n                    .data('revision', i)\n                    .addClass('revision-selector-label-active');\n            }\n        });\n\n        for (i = 0; i < this._numHandles; i++) {\n            $('<div/>')\n                .addClass('revision-selector-handle rb-icon rb-icon-range-slider')\n                .data('handle-id', i)\n                .appendTo(this._$handles);\n        }\n\n        this._rendered = true;\n        this._update();\n\n        return this;\n    },\n\n    /**\n     * Update the position of the handles.\n     *\n     * If a drag is currently active, this will draw using the pending state.\n     * Otherwise, it will show the actual revisions.\n     */\n    _updateHandles() {\n        const positions = this._positions;\n        const values = this._mouseActive ? this._activeValues\n                                         : this._values;\n\n        this._$handles.children().each((i, el) => {\n            $(el).css('left', (positions[values[i]] - 4) + 'px');\n        });\n\n        if (this._numHandles === 2) {\n            this._$range.css({\n                'left': positions[values[0]] + 'px',\n                'width': positions[values[1] - values[0]] + 'px',\n            });\n        }\n    },\n\n    /**\n     * Callback for when a handle is clicked. Starts a drag.\n     *\n     * This will register for the various events used to handle the drag\n     * operation.\n     *\n     * Args:\n     *     ev (Event):\n     *         The mousedown event.\n     */\n    _onHandleMouseDown(ev) {\n        ev.preventDefault();\n        ev.stopPropagation();\n\n        this._activeValues = [];\n\n        for (let i = 0; i < this._values.length; i++) {\n            this._activeValues.push(i);\n        }\n\n        this._mouseActive = true;\n        this._activeHandle = $(ev.currentTarget).data('handle-id');\n\n        document.addEventListener('mouseup', this._onHandleMouseUp, true);\n        document.addEventListener('mousemove', this._onHandleMouseMove, true);\n\n        $('body').addClass('revision-selector-grabbed');\n    },\n\n    /**\n     * Callback for when a mouseup event occurs anywhere.\n     *\n     * Triggers the 'revisionSelected' event with the new revisions.\n     * Removes event handlers used during the drag operation.\n     *\n     * Args:\n     *     ev (Event):\n     *         The mouseup event.\n     */\n    _onHandleMouseUp(ev) {\n        console.assert(this._mouseActive);\n\n        ev.stopPropagation();\n        ev.preventDefault();\n\n        this._mouseActive = false;\n        this._activeHandle = null;\n\n        document.removeEventListener('mouseup', this._onHandleMouseUp, true);\n        document.removeEventListener('mousemove', this._onHandleMouseMove, true);\n\n        $('body').removeClass('revision-selector-grabbed');\n\n        if (!_.isEqual(this._activeValues, this._values)) {\n            this.trigger('revisionSelected', this._activeValues);\n        }\n    },\n\n    /**\n     * Callback for a mousemove event anywhere.\n     *\n     * Updates the \"active\" values to select the revisions closest to the\n     * current location of the mouse.\n     *\n     * Args:\n     *     ev (Event):\n     *         The mousemove event.\n     */\n    _onHandleMouseMove(ev) {\n        console.assert(this._mouseActive);\n\n        const mouseX = (window.pageXOffset + ev.clientX -\n                        this._$trough.offset().left);\n        let closestPos;\n        let closestDist;\n\n        for (let i = 0; i < this._positions.length; i++) {\n            const dist = Math.abs(this._positions[i] - mouseX);\n\n            if (closestDist === undefined || dist < closestDist) {\n                closestDist = dist;\n                closestPos = i;\n            }\n        }\n\n        if (this._numHandles === 1) {\n            this._activeValues[0] = closestPos;\n        } else if (this._numHandles === 2) {\n            /*\n             * The two-handle case is complex, because we always want the first\n             * value to be less than the second. The below creates a \"pushing\"\n             * behavior where if you slide the left handle to the right, it\n             * will \"push\" the right handle to always have a span of at least\n             * one revision, and vice-versa.\n             */\n            if (this._activeHandle === 0) {\n                // Pushing to the right\n                this._activeValues[0] = Math.min(\n                    closestPos, this._positions.length - 2);\n\n                if (this._values[1] <= this._activeValues[0]) {\n                    this._activeValues[1] = this._activeValues[0] + 1;\n                } else {\n                    this._activeValues[1] = this._values[1];\n                }\n            } else if (this._activeHandle === 1) {\n                // Pushing to the left\n                this._activeValues[1] = Math.max(closestPos, 1);\n\n                if (this._values[0] >= this._activeValues[1]) {\n                    this._activeValues[0] = this._activeValues[1] - 1;\n                } else {\n                    this._activeValues[0] = this._values[0];\n                }\n            }\n        }\n\n        this._updateHandles();\n    },\n});\n"],"mappings":";;AAAA;AACA;AACA;AACA;AACAA,EAAE,CAACC,oBAAH,GAA0BC,QAAQ,CAACC,IAAT,CAAcC,MAAd,CAAqB;EAC3CC,QAAQ,EAAEC,CAAC,CAACD,QAAF,CAAkB;AAChC;AACA;AACA;AACA;AACA;AACA,OANc,CADiC;EAW3CE,MAAM,EAAE;IACJ,uCAAuC,oBADnC;IAEJ,sCAAsC,mBAFlC;IAGJ,kCAAkC;EAH9B,CAXmC;;EAiB3C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACIC,UAAU,CAACC,OAAD,EAAU;IAChBC,OAAO,CAACC,MAAR,CAAeL,CAAC,CAACM,QAAF,CAAWH,OAAX,CAAf;IACAC,OAAO,CAACC,MAAR,CAAeF,OAAO,CAACI,UAAR,KAAuB,CAAvB,IAA4BJ,OAAO,CAACI,UAAR,KAAuB,CAAlE;IAEA,KAAKC,aAAL,GAAqB,IAArB;IACA,KAAKC,iBAAL,GAAyBN,OAAO,CAACO,gBAAjC;IACA,KAAKC,YAAL,GAAoB,KAApB;IACA,KAAKC,WAAL,GAAmBT,OAAO,CAACI,UAA3B;IACA,KAAKM,OAAL,GAAe,EAAf;IAEA,KAAKC,SAAL,GAAiB,KAAjB;IAEA,KAAKC,QAAL,CAAc,KAAKC,KAAnB,EAA0B,QAA1B,EAAoC,KAAKC,OAAzC;;IAEAjB,CAAC,CAACkB,OAAF,CAAU,IAAV,EAAgB,kBAAhB,EAAoC,oBAApC;EACH,CA/C0C;;EAiD3C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACIC,MAAM,CAACC,cAAD,EAAiB;IACnB,KAAKC,GAAL,CAASC,IAAT,CAAc,KAAKvB,QAAL,EAAd;IAEA,KAAKwB,UAAL,GAAkB,EAAlB;IAEA,IAAIC,CAAJ;;IAEA,KAAKA,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGJ,cAAc,CAACK,MAA/B,EAAuCD,CAAC,EAAxC,EAA4C;MACxC;MACA,KAAKD,UAAL,CAAgBG,IAAhB,CAAqBF,CAAC,GAAG,EAAzB;IACH;;IAED,KAAKG,SAAL,GAAiB,KAAKC,CAAL,CAAO,4BAAP,CAAjB;IACA,KAAKC,OAAL,GAAe,KAAKD,CAAL,CAAO,0BAAP,CAAf;IACA,KAAKE,OAAL,GAAe,KAAKF,CAAL,CAAO,0BAAP,CAAf;IACA,KAAKG,QAAL,GAAgB,KAAKH,CAAL,CAAO,2BAAP,CAAhB;IACA,KAAKI,QAAL,GAAgB,KAAKJ,CAAL,CAAO,2BAAP,EACXK,KADW,CACL,KAAKV,UAAL,CAAgBC,CAAC,GAAG,CAApB,CADK,CAAhB;;IAGAxB,CAAC,CAACkC,IAAF,CAAOd,cAAP,EAAuB,CAACe,KAAD,EAAQX,CAAR,KAAc;MACjCI,CAAC,CAAC,QAAD,CAAD,CACKQ,QADL,CACc,wBADd,EAEKC,GAFL,CAES,MAFT,EAEiB,KAAKd,UAAL,CAAgBC,CAAhB,IAAqB,IAFtC,EAGKc,QAHL,CAGc,KAAKR,OAHnB;MAKA,MAAMS,MAAM,GAAGX,CAAC,CAAC,QAAD,CAAD,CACVY,IADU,CACLL,KADK,EAEVC,QAFU,CAED,yBAFC,EAGVE,QAHU,CAGD,KAAKP,QAHJ,CAAf;MAKAQ,MAAM,CAACF,GAAP,CAAW,MAAX,EAAoB,KAAKd,UAAL,CAAgBC,CAAhB,IACCe,MAAM,CAACN,KAAP,KAAiB,CADnB,GACyB,IAD5C;;MAGA,IAAI,KAAKxB,iBAAL,IAA0Be,CAAC,GAAG,CAAlC,EAAqC;QACjCe,MAAM,CACDE,IADL,CACU,UADV,EACsBjB,CADtB,EAEKY,QAFL,CAEc,gCAFd;MAGH;IACJ,CAnBD;;IAqBA,KAAKZ,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAG,KAAKZ,WAArB,EAAkCY,CAAC,EAAnC,EAAuC;MACnCI,CAAC,CAAC,QAAD,CAAD,CACKQ,QADL,CACc,uDADd,EAEKK,IAFL,CAEU,WAFV,EAEuBjB,CAFvB,EAGKc,QAHL,CAGc,KAAKX,SAHnB;IAIH;;IAED,KAAKb,SAAL,GAAiB,IAAjB;;IACA,KAAKG,OAAL;;IAEA,OAAO,IAAP;EACH,CA/G0C;;EAiH3C;AACJ;AACA;AACA;AACA;AACA;EACIyB,cAAc,GAAG;IACb,MAAMC,SAAS,GAAG,KAAKpB,UAAvB;IACA,MAAMqB,MAAM,GAAG,KAAKjC,YAAL,GAAoB,KAAKkC,aAAzB,GACoB,KAAKhC,OADxC;;IAGA,KAAKc,SAAL,CAAemB,QAAf,GAA0BZ,IAA1B,CAA+B,CAACV,CAAD,EAAIuB,EAAJ,KAAW;MACtCnB,CAAC,CAACmB,EAAD,CAAD,CAAMV,GAAN,CAAU,MAAV,EAAmBM,SAAS,CAACC,MAAM,CAACpB,CAAD,CAAP,CAAT,GAAuB,CAAxB,GAA6B,IAA/C;IACH,CAFD;;IAIA,IAAI,KAAKZ,WAAL,KAAqB,CAAzB,EAA4B;MACxB,KAAKiB,OAAL,CAAaQ,GAAb,CAAiB;QACb,QAAQM,SAAS,CAACC,MAAM,CAAC,CAAD,CAAP,CAAT,GAAuB,IADlB;QAEb,SAASD,SAAS,CAACC,MAAM,CAAC,CAAD,CAAN,GAAYA,MAAM,CAAC,CAAD,CAAnB,CAAT,GAAmC;MAF/B,CAAjB;IAIH;EACJ,CAtI0C;;EAwI3C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACII,kBAAkB,CAACC,EAAD,EAAK;IACnBA,EAAE,CAACC,cAAH;IACAD,EAAE,CAACE,eAAH;IAEA,KAAKN,aAAL,GAAqB,EAArB;;IAEA,KAAK,IAAIrB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKX,OAAL,CAAaY,MAAjC,EAAyCD,CAAC,EAA1C,EAA8C;MAC1C,KAAKqB,aAAL,CAAmBnB,IAAnB,CAAwBF,CAAxB;IACH;;IAED,KAAKb,YAAL,GAAoB,IAApB;IACA,KAAKH,aAAL,GAAqBoB,CAAC,CAACqB,EAAE,CAACG,aAAJ,CAAD,CAAoBX,IAApB,CAAyB,WAAzB,CAArB;IAEAY,QAAQ,CAACC,gBAAT,CAA0B,SAA1B,EAAqC,KAAKC,gBAA1C,EAA4D,IAA5D;IACAF,QAAQ,CAACC,gBAAT,CAA0B,WAA1B,EAAuC,KAAKE,kBAA5C,EAAgE,IAAhE;IAEA5B,CAAC,CAAC,MAAD,CAAD,CAAUQ,QAAV,CAAmB,2BAAnB;EACH,CAnK0C;;EAqK3C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACImB,gBAAgB,CAACN,EAAD,EAAK;IACjB7C,OAAO,CAACC,MAAR,CAAe,KAAKM,YAApB;IAEAsC,EAAE,CAACE,eAAH;IACAF,EAAE,CAACC,cAAH;IAEA,KAAKvC,YAAL,GAAoB,KAApB;IACA,KAAKH,aAAL,GAAqB,IAArB;IAEA6C,QAAQ,CAACI,mBAAT,CAA6B,SAA7B,EAAwC,KAAKF,gBAA7C,EAA+D,IAA/D;IACAF,QAAQ,CAACI,mBAAT,CAA6B,WAA7B,EAA0C,KAAKD,kBAA/C,EAAmE,IAAnE;IAEA5B,CAAC,CAAC,MAAD,CAAD,CAAU8B,WAAV,CAAsB,2BAAtB;;IAEA,IAAI,CAAC1D,CAAC,CAAC2D,OAAF,CAAU,KAAKd,aAAf,EAA8B,KAAKhC,OAAnC,CAAL,EAAkD;MAC9C,KAAK+C,OAAL,CAAa,kBAAb,EAAiC,KAAKf,aAAtC;IACH;EACJ,CAhM0C;;EAkM3C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACIW,kBAAkB,CAACP,EAAD,EAAK;IACnB7C,OAAO,CAACC,MAAR,CAAe,KAAKM,YAApB;;IAEA,MAAMkD,MAAM,GAAIC,MAAM,CAACC,WAAP,GAAqBd,EAAE,CAACe,OAAxB,GACA,KAAKhC,QAAL,CAAciC,MAAd,GAAuBC,IADvC;;IAEA,IAAIC,UAAJ;IACA,IAAIC,WAAJ;;IAEA,KAAK,IAAI5C,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKD,UAAL,CAAgBE,MAApC,EAA4CD,CAAC,EAA7C,EAAiD;MAC7C,MAAM6C,IAAI,GAAGC,IAAI,CAACC,GAAL,CAAS,KAAKhD,UAAL,CAAgBC,CAAhB,IAAqBqC,MAA9B,CAAb;;MAEA,IAAIO,WAAW,KAAKI,SAAhB,IAA6BH,IAAI,GAAGD,WAAxC,EAAqD;QACjDA,WAAW,GAAGC,IAAd;QACAF,UAAU,GAAG3C,CAAb;MACH;IACJ;;IAED,IAAI,KAAKZ,WAAL,KAAqB,CAAzB,EAA4B;MACxB,KAAKiC,aAAL,CAAmB,CAAnB,IAAwBsB,UAAxB;IACH,CAFD,MAEO,IAAI,KAAKvD,WAAL,KAAqB,CAAzB,EAA4B;MAC/B;AACZ;AACA;AACA;AACA;AACA;AACA;MACY,IAAI,KAAKJ,aAAL,KAAuB,CAA3B,EAA8B;QAC1B;QACA,KAAKqC,aAAL,CAAmB,CAAnB,IAAwByB,IAAI,CAACG,GAAL,CACpBN,UADoB,EACR,KAAK5C,UAAL,CAAgBE,MAAhB,GAAyB,CADjB,CAAxB;;QAGA,IAAI,KAAKZ,OAAL,CAAa,CAAb,KAAmB,KAAKgC,aAAL,CAAmB,CAAnB,CAAvB,EAA8C;UAC1C,KAAKA,aAAL,CAAmB,CAAnB,IAAwB,KAAKA,aAAL,CAAmB,CAAnB,IAAwB,CAAhD;QACH,CAFD,MAEO;UACH,KAAKA,aAAL,CAAmB,CAAnB,IAAwB,KAAKhC,OAAL,CAAa,CAAb,CAAxB;QACH;MACJ,CAVD,MAUO,IAAI,KAAKL,aAAL,KAAuB,CAA3B,EAA8B;QACjC;QACA,KAAKqC,aAAL,CAAmB,CAAnB,IAAwByB,IAAI,CAACI,GAAL,CAASP,UAAT,EAAqB,CAArB,CAAxB;;QAEA,IAAI,KAAKtD,OAAL,CAAa,CAAb,KAAmB,KAAKgC,aAAL,CAAmB,CAAnB,CAAvB,EAA8C;UAC1C,KAAKA,aAAL,CAAmB,CAAnB,IAAwB,KAAKA,aAAL,CAAmB,CAAnB,IAAwB,CAAhD;QACH,CAFD,MAEO;UACH,KAAKA,aAAL,CAAmB,CAAnB,IAAwB,KAAKhC,OAAL,CAAa,CAAb,CAAxB;QACH;MACJ;IACJ;;IAED,KAAK6B,cAAL;EACH;;AA9P0C,CAArB,CAA1B"}