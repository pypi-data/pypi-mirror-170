{"version":3,"file":"abstractCommentBlockModel.js","names":["RB","AbstractCommentBlock","Backbone","Model","extend","defaults","hasDraft","canDelete","draftComment","reviewRequest","review","serializedComments","count","initialize","console","assert","get","comments","newSerializedComments","length","forEach","comment","text","$","html","localdraft","ensureDraftComment","comment_id","richText","rich_text","issueOpened","issue_opened","issueStatus","issue_status","push","set","on","_updateCount","isEmpty","has","createComment","id","comment_attr"],"sources":["../../../../../static/rb/js/models/abstractCommentBlockModel.es6.js"],"sourcesContent":["/**\n * Represents a region of reviewable content that contains comments.\n *\n * This stores all comments that match a given region, as defined by a\n * subclass of AbstractCommentBlock.\n *\n * New draft comments can be created, which will later be stored on the\n * server.\n *\n * The total number of comments in the block (including any draft comment)\n * will be stored, which may be useful for display.\n *\n * Model Attributes:\n *     canDelete (boolean):\n *         Whether or not the comment can be deleted.\n *\n *     count (number):\n *         The total number of comments, including a draft comment.\n *\n *     draftComment (RB.BaseComment):\n *         The draft comment that this block is associated with.\n *\n *     hasDraft (boolean):\n *         Whether or not the review request has a draft.\n *\n *     review (RB.Review):\n *         The review that the associated comment is a part of.\n *\n *     reviewRequest (RB.ReviewRequest):\n *         The review request that this comment is on.\n *\n *     serializedComments (Array of object):\n *         An array of serialized comments for display.\n */\nRB.AbstractCommentBlock = Backbone.Model.extend({\n    defaults: {\n        hasDraft: false,\n        canDelete: false,\n        draftComment: null,\n        reviewRequest: null,\n        review: null,\n        serializedComments: [],\n        count: 0\n    },\n\n    /**\n     * Initialize the AbstractCommentBlock.\n     */\n    initialize() {\n        console.assert(this.get('reviewRequest'),\n                       'reviewRequest must be provided');\n        console.assert(this.get('review'),\n                       'review must be provided');\n\n        /*\n         * Find out if there are any draft comments and filter them out of the\n         * stored list of comments.\n         */\n        const comments = this.get('serializedComments');\n        const newSerializedComments = [];\n\n        if (comments.length > 0) {\n            comments.forEach(comment => {\n                // We load in encoded text, so decode it.\n                comment.text = $('<div>').html(comment.text).text();\n\n                if (comment.localdraft) {\n                    this.ensureDraftComment(comment.comment_id, {\n                        text: comment.text,\n                        richText: comment.rich_text,\n                        issueOpened: comment.issue_opened,\n                        issueStatus: comment.issue_status,\n                        html: comment.html,\n                    });\n                } else {\n                    newSerializedComments.push(comment);\n                }\n            }, this);\n\n            this.set('serializedComments', newSerializedComments);\n        } else {\n            this.ensureDraftComment();\n        }\n\n        this.on('change:draftComment', this._updateCount, this);\n        this._updateCount();\n    },\n\n    /**\n     * Return whether or not the comment block is empty.\n     *\n     * A comment block is empty if there are no stored comments and no\n     * draft comment.\n     *\n     * Returns:\n     *     boolean:\n     *     Whether the comment block is empty.\n     */\n    isEmpty() {\n        return (this.get('serializedComments').length === 0 &&\n                !this.has('draftComment'));\n    },\n\n    /**\n     * Create a draft comment, optionally with a given ID and text.\n     *\n     * This must be implemented by a subclass to return a Comment class\n     * specific to the subclass.\n     *\n     * Args:\n     *     id (number):\n     *         The ID of the comment to instantiate the model for.\n     *\n     * Returns:\n     *     RB.BaseComment:\n     *     The new comment model.\n     */\n    createComment(id) {\n        console.assert(false, 'This must be implemented by a subclass');\n    },\n\n    /**\n     * Create a draft comment in this comment block.\n     *\n     * Only one draft comment can exist per block, so if one already exists,\n     * this will do nothing.\n     *\n     * The actual comment object is up to the subclass to create.\n     *\n     * Args:\n     *     id (number):\n     *         The ID of the comment.\n     *\n     *     comment_attr (object):\n     *         Attributes to set on the comment model.\n     */\n    ensureDraftComment(id, comment_attr) {\n        if (this.has('draftComment')) {\n            return;\n        }\n\n        const comment = this.createComment(id);\n        comment.set(comment_attr);\n        comment.on('saved', this._updateCount, this);\n        comment.on('destroy', () => {\n            this.set('draftComment', null);\n            this._updateCount();\n        });\n\n        this.set('draftComment', comment);\n    },\n\n    /**\n     * Update the displayed number of comments in the comment block.\n     *\n     * If there's a draft comment, it will be added to the count. Otherwise,\n     * this depends solely on the number of published comments.\n     */\n    _updateCount() {\n        let count = this.get('serializedComments').length;\n\n        if (this.has('draftComment')) {\n            count++;\n        }\n\n        this.set('count', count);\n    },\n});\n"],"mappings":"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"}