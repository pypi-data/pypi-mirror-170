{"version":3,"file":"reviewReplyEditorViewTests.js","names":["suite","reviewReply","editor","view","beforeEach","$container","$","appendTo","$testsScratch","RB","ReviewReply","id","spyOn","and","resolveTo","ReviewRequestPage","ReviewReplyEditor","anchorPrefix","replyObject","review","Review","parentObject","ReviewRequest","contextType","contextID","ReviewReplyEditorView","model","el","_$commentsList","append","describe","it","commentText","now","moment","$el","_makeCommentElement","commentID","text","render","expect","get","toBe","valueOf","milliseconds","_$draftComment","_$addCommentLink","is","click","not","hasClass","done","length","on","trigger","$draftEl","fn","callThrough","set","data","user_infobox","toHaveBeenCalled","timesince","$anchor","children","attr","$floatingAnchor","find","openCommentEditor","testRendering","richText","expectedHTML","$comment","$reviewText","html"],"sources":["../../../../../../../static/rb/js/reviewRequestPage/views/tests/reviewReplyEditorViewTests.es6.js"],"sourcesContent":["suite('rb/reviewRequestPage/views/ReviewReplyEditorView', function() {\n    let reviewReply;\n    let editor;\n    let view;\n\n    beforeEach(function() {\n        const $container = $('<div/>').appendTo($testsScratch);\n\n        reviewReply = new RB.ReviewReply({\n            id: 121\n        });\n\n        /* Some tests will invoke this, so just pretend it works. */\n        spyOn(reviewReply, 'discardIfEmpty').and.resolveTo(true);\n\n        editor = new RB.ReviewRequestPage.ReviewReplyEditor({\n            anchorPrefix: 'header-reply',\n            replyObject: reviewReply,\n            review: new RB.Review({\n                id: 42,\n                parentObject: new RB.ReviewRequest(),\n            }),\n            reviewReply: reviewReply,\n            contextType: 'rcbt',\n            contextID: '100',\n        });\n\n        view = new RB.ReviewRequestPage.ReviewReplyEditorView({\n            model: editor,\n            el: $testsScratch,\n        });\n\n        /* Necessary to do pre-render so we can use makeCommentElement. */\n        view._$commentsList = $('<ul class=\"reply-comments\"/>');\n\n        $container\n            .append(view._$commentsList)\n            .append($('<a href=\"#\" class=\"add_comment_link\">New Comment</a>'));\n    });\n\n    describe('Construction', function() {\n        it('Populate from draft comment', function() {\n            const commentText = 'Test comment';\n            const now = moment();\n            const $el = view._makeCommentElement({\n                commentID: 16,\n                now: now,\n                text: commentText,\n            });\n\n            view.render();\n\n            expect(editor.get('commentID')).toBe(16);\n            expect(editor.get('text')).toBe(commentText);\n            expect(editor.get('hasDraft')).toBe(true);\n            expect(editor.get('timestamp').valueOf())\n                .toBe(now.milliseconds(0).valueOf());\n            expect(view._$draftComment[0]).toBe($el[0]);\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n        });\n    });\n\n    describe('Actions', function() {\n        it('Add comment link', function() {\n            view.render();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(true);\n            view._$addCommentLink.click();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n            expect(view._$draftComment).not.toBe(null);\n            expect(view._$draftComment.hasClass('draft')).toBe(true);\n        });\n    });\n\n    describe('Event handling', function() {\n        it('Comment discarded', function(done) {\n            view._makeCommentElement({\n                text: 'Test comment',\n            });\n\n            view.render();\n\n            let $el = view.$('.reply-comments li');\n            expect($el.length).toBe(1);\n\n            editor.on('discarded-finished', () => {\n                $el = view.$('.reply-comments li');\n                expect($el.length).toBe(0);\n                expect(view._$draftComment).toBe(null);\n\n                done();\n            });\n\n            reviewReply.trigger('destroyed');\n        });\n\n        it('Comment published', function() {\n            const $draftEl = view._makeCommentElement({\n                commentID: 16,\n            });\n\n            spyOn($.fn, 'user_infobox').and.callThrough();\n            spyOn($.fn, 'timesince').and.callThrough();\n\n            view.render();\n            editor.set('text', 'Test **comment**');\n            reviewReply.trigger('published');\n\n            const $el = view.$('.reply-comments li');\n\n            expect($el.length).toBe(1);\n            expect($draftEl).not.toBe($el);\n            expect($el.hasClass('draft')).toBe(false);\n            expect($el.data('comment-id')).toBe(16);\n            expect(view._$draftComment).toBe(null);\n            expect($.fn.user_infobox).toHaveBeenCalled();\n            expect($.fn.timesince).toHaveBeenCalled();\n\n            const $anchor = $el.children('.comment-anchor');\n            expect($anchor.length).toBe(1);\n            expect($anchor.attr('name')).toBe('header-reply121');\n\n            const $floatingAnchor = $el.find('> .floating-anchor > a');\n            expect($floatingAnchor.length).toBe(1);\n            expect($floatingAnchor.attr('href')).toBe('#header-reply121');\n            expect($floatingAnchor.hasClass('fa fa-link fa-flip-horizontal'))\n                .toBe(true);\n        });\n    });\n\n    describe('Methods', function() {\n        it('openCommentEditor', function() {\n            view.render();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(true);\n            expect(view._$draftComment).toBe(null);\n\n            view.openCommentEditor();\n\n            expect(view._$addCommentLink.is(':visible')).toBe(false);\n            expect(view._$draftComment).not.toBe(null);\n            expect(view._$draftComment.hasClass('draft')).toBe(true);\n        });\n    });\n\n    describe('Text rendering', function() {\n        function testRendering(richText, expectedHTML) {\n            view.render();\n\n            const $comment = view._makeCommentElement({\n                text: '<p><strong>Test</strong> &amp;lt;</p>',\n                richText: richText,\n            });\n\n            const $reviewText = $comment.find('.reviewtext');\n            expect($reviewText.length).toBe(1);\n            expect($reviewText.hasClass('rich-text')).toBe(richText);\n            expect($reviewText.html()).toBe(expectedHTML);\n        }\n\n        it('richText=true', function() {\n            testRendering(true, '<p><strong>Test</strong> &amp;lt;</p>');\n        });\n\n        it('richText=false', function() {\n            testRendering(false,\n                          '&lt;p&gt;&lt;strong&gt;Test&lt;/strong&gt; ' +\n                          '&amp;amp;lt;&lt;/p&gt;');\n        });\n    });\n});\n"],"mappings":"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"}