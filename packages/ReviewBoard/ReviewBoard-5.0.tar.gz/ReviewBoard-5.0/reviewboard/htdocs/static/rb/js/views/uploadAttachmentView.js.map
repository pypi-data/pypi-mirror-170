{"version":3,"file":"uploadAttachmentView.js","names":["RB","UploadAttachmentView","DialogView","extend","className","title","buttons","id","label","primary","disabled","onClick","template","_","events","prototype","initialize","options","defaults","attachmentHistoryID","presetCaption","body","captionText","pathText","call","$","send","attrs","saveAttrs","form","reviewRequestEditor","createFileAttachment","save","then","remove","catch","err","displayErrors","parseJSON","xhr","responseText","rsp","errorStr","msg","text","show","fields","nameToRow","caption","path","fieldName","hasOwnProperty","$errorList","css","elIndex","errorListEl","i","length","html","appendTo","render","_$path","_$uploadBtn","$buttonsMap","upload","updateUploadButtonEnabledState","enable","val"],"sources":["../../../../../static/rb/js/views/uploadAttachmentView.es6.js"],"sourcesContent":["/**\n * A dialog for updating file attachments.\n */\nRB.UploadAttachmentView = RB.DialogView.extend({\n    className: 'upload-attachment',\n    title: gettext('Upload File'),\n    buttons: [\n        {\n            id: 'cancel',\n            label: gettext('Cancel'),\n        },\n        {\n            id: 'upload',\n            label: gettext('Upload'),\n            primary: true,\n            disabled: true,\n            onClick: 'send',\n        },\n    ],\n    template: _.template(dedent`\n        <div class=\"formdlg\" style=\"width: 50em;\">\n         <div class=\"error\" style=\"display: none;\"></div>\n         <form encoding=\"multipart/form-data\" enctype=\"multipart/form-data\"\n               id=\"attachment-upload-form\">\n          <table>\n           <tbody>\n            <tr>\n             <td class=\"label\"><label><%- captionText %></label></td>\n             <td>\n              <input name=\"caption\" type=\"text\" value=\"<%- presetCaption %>\">\n             </td>\n             <td><ul class=\"errorlist\" style=\"display: none;\"></ul></td>\n            </tr>\n            <tr>\n             <td class=\"label\">\n              <label class=\"required\"><%- pathText %></label>\n             </td>\n             <td><input name=\"path\" id=\"path\" type=\"file\" class=\"js-path\"></td>\n             <td><ul class=\"errorlist\" style=\"display: none;\"></ul></td>\n            </tr>\n           </tbody>\n          </table>\n          <% if (attachmentHistoryID >= 0) { %>\n            <input type=\"hidden\" name=\"attachment_history\"\n                   value=\"<%- attachmentHistoryID %>\" />\n          <% } %>\n         </form>\n        </div>\n    `),\n\n    events: _.extend({\n        'change .js-path': 'updateUploadButtonEnabledState',\n    }, RB.DialogView.prototype.events),\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     attachmentHistoryID (number, optional):\n     *         The ID of the attachment history to add to. This can be omitted\n     *         if this is a new attachment (as opposed to updating an existing\n     *         one).\n     *\n     *     presetCaption (string):\n     *         The initial caption of the attachment.\n     *\n     *     reviewRequestEditor (RB.ReviewRequestEditor):\n     *         The review request editor.\n     */\n    initialize: function(options={}) {\n        _.defaults(options, {\n            attachmentHistoryID: -1,\n            presetCaption: '',\n        });\n\n        const body = this.template({\n            attachmentHistoryID: options.attachmentHistoryID,\n            captionText: gettext('Caption:'),\n            pathText: gettext('Path:'),\n            presetCaption: options.presetCaption,\n        });\n\n        RB.DialogView.prototype.initialize.call(this, $.extend({\n            body: body,\n        }, options));\n    },\n\n    /**\n     * Create a file attachment on the review request.\n     *\n     * On success, the dialog will be closed.\n     *\n     * Otherwise, on error, the dialog will display the errors.\n     */\n    send() {\n        const attrs = {\n            attachmentHistoryID: this.options.attachmentHistoryID,\n        };\n        const saveAttrs = {\n            form: this.$('#attachment-upload-form'),\n        };\n\n        this.options.reviewRequestEditor.createFileAttachment(attrs)\n            .save(saveAttrs)\n            .then(() => {\n                // Close 'Add File' modal.\n                this.remove();\n            })\n            .catch(err => {\n                this.displayErrors($.parseJSON(err.xhr.responseText));\n            });\n    },\n\n    /**\n     * Display errors on the form.\n     *\n     * Args:\n     *     rsp (object):\n     *         The server response.\n     */\n    displayErrors(rsp) {\n        const errorStr = ((rsp && rsp.err)\n                          ? rsp.err.msg\n                          : gettext('Unknown Error'));\n\n        this.$('.error')\n            .text(errorStr)\n            .show();\n\n        if (rsp && rsp.fields) {\n            /* Invalid form data */\n            const nameToRow = {\n                caption: 0,\n                path: 1,\n            };\n\n            for (let fieldName in rsp.fields) {\n                if (rsp.fields.hasOwnProperty(fieldName)) {\n                    const $errorList = this.$('.errorlist')\n                        .css('display', 'block');\n                    const elIndex = nameToRow[fieldName];\n                    const errorListEl = $errorList[elIndex];\n\n                    for (let i = 0; i < rsp.fields[fieldName].length; i++) {\n                        $('<li>')\n                            .html(rsp.fields[fieldName][i])\n                            .appendTo(errorListEl);\n                    }\n                }\n            }\n        }\n    },\n\n    /**\n     * Render the dialog.\n     *\n     * Returns:\n     *     RB.UploadAttachmentView:\n     *     This object, for chaining.\n     */\n    render() {\n        RB.DialogView.prototype.render.call(this);\n\n        this._$path = this.$('.js-path');\n        this._$uploadBtn = this.$buttonsMap.upload;\n\n        return this;\n    },\n\n    /**\n     * Set the upload button to be clickable or not based on context.\n     */\n    updateUploadButtonEnabledState() {\n        this._$uploadBtn.enable(this._$path.val());\n    },\n});\n"],"mappings":"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"}