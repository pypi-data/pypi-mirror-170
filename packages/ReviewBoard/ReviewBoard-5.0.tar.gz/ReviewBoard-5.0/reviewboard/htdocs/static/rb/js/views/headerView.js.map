{"version":3,"file":"headerView.js","names":["RB","HeaderView","Backbone","View","extend","SEARCH_SUMMARY_TRIM_LEN","DESKTOP_SEARCH_RESULTS_WIDTH","events","_ensureSingleton","instance","console","warn","initialize","options","isRendered","_mobileMenuOpened","_$window","_$body","_$navToggle","_$mobileMenuMask","remove","off","_recalcFunc","prototype","call","render","$","window","body","document","on","_closeMobileMenu","bind","insertAfter","$pageSidebar","_","throttle","_recalcMobileMode","_setupSearch","_handleNavClick","e","stopPropagation","preventDefault","_setMobileMenuOpened","inMobileMode","is","trigger","_$search","rbautocomplete","formatItem","data","s","username","fullname","escape","name","displayName","display_name","summary","length","substring","id","matchCase","multiple","clickToURL","selectFirst","width","enterToURL","resultsParentEl","resultsClass","parse","objects","keys","parsed","j","object","items","search","i","value","key","push","result","public","url","SITE_ROOT","extraParams","opened","show","defer","addClass","removeClass","delay","hide"],"sources":["../../../../../static/rb/js/views/headerView.es6.js"],"sourcesContent":["/**\n * Site Header\n */\nRB.HeaderView = Backbone.View.extend({\n    SEARCH_SUMMARY_TRIM_LEN: 28,\n    DESKTOP_SEARCH_RESULTS_WIDTH: 350,\n\n    events: {\n        'click #nav_toggle': '_handleNavClick',\n        'touchstart #nav_toggle': '_handleNavClick',\n        'focus #search_field': '_closeMobileMenu',\n    },\n\n    /**\n     * Ensure that this HeaderView is the only one on the page.\n     *\n     * This exists in a separate function so that unit tests can disable this\n     * check.\n     */\n    _ensureSingleton() {\n        if (RB.HeaderView.instance !== null) {\n            console.warn('There are two instances of RB.HeaderView on the ' +\n                         'page. Make sure only one RB.PageView is ' +\n                         'instantiated and registered through ' +\n                         'RB.PageManager.setupPage().');\n        } else {\n            RB.HeaderView.instance = this;\n        }\n    },\n\n    /**\n     * Initialize the header.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     $body (jQuery, optional):\n     *         The body element. This is useful for unit tests.\n     *\n     *     $pageSidebar (jQuery, optional):\n     *         The page sidebar element. This is useful for unit tests.\n     */\n    initialize(options={}) {\n        this._ensureSingleton();\n\n        this.options = options;\n\n        /*\n         * This is used by RB.PageManager to determine if a RB.PageView\n         * subclass has correctly rendered a HeaderView, or if PageManager\n         * needs to take care of it.\n         *\n         * This is deprecated and can be removed in Review Board 5.0.\n         */\n        this.isRendered = false;\n\n        this._mobileMenuOpened = false;\n\n        this._$window = null;\n        this._$body = null;\n        this._$navToggle = null;\n        this._$mobileMenuMask = null;\n    },\n\n    /**\n     * Remove the view from the DOM and disable event handling.\n     *\n     * This will also unset :js:attr:`RB.HeaderView.instance`, if currently\n     * set to this instance.\n     */\n    remove() {\n        if (RB.HeaderView.instance === this) {\n            RB.HeaderView.instance = null;\n        }\n\n        if (this._$window) {\n            this._$window.off('resize.rbHeaderView', this._recalcFunc);\n        }\n\n        Backbone.View.prototype.remove.call(this);\n    },\n\n    /**\n     * Render the header.\n     *\n     * Returns:\n     *     RB.HeaderView:\n     *     This view, for chaining.\n     */\n    render() {\n        const options = this.options;\n\n        this._$window = $(window);\n        this._$body = options.body || $(document.body);\n        this._$navToggle = $('#nav_toggle');\n        this._$mobileMenuMask = $('<div id=\"mobile_menu_mask\"/>')\n            .on('click touchstart', this._closeMobileMenu.bind(this))\n            .insertAfter(options.$pageSidebar || $('#page-sidebar'));\n\n        this._recalcFunc = _.throttle(this._recalcMobileMode.bind(this), 100);\n\n        this._$window.on('resize.rbHeaderView', this._recalcFunc);\n        this._recalcMobileMode();\n\n        this._setupSearch();\n\n        this.isRendered = true;\n\n        return this;\n    },\n\n    /**\n     * Handle a click on the mobile navigation menu.\n     *\n     * Args:\n     *     e (Event):\n     *         The click event.\n     */\n    _handleNavClick(e) {\n        e.stopPropagation();\n        e.preventDefault();\n\n        this._setMobileMenuOpened(!this._mobileMenuOpened);\n    },\n\n    /**\n     * Recalculate whether the header and nav menu is in mobile mode.\n     */\n    _recalcMobileMode() {\n        const inMobileMode = this._$navToggle.is(':visible');\n\n        if (inMobileMode === this.inMobileMode) {\n            return;\n        }\n\n        if (!inMobileMode) {\n            this._setMobileMenuOpened(false);\n        }\n\n        this.inMobileMode = inMobileMode;\n        this.trigger('mobileModeChanged', inMobileMode);\n    },\n\n    /**\n     * Close the mobile menu.\n     *\n     * This is used as an event handler, to make it easy to close the\n     * mobile menu and prevent any bubbling or default actions from the\n     * event.\n     */\n    _closeMobileMenu() {\n        this._setMobileMenuOpened(false);\n\n        return false;\n    },\n\n    /**\n     * Set up the search auto-complete field.\n     */\n    _setupSearch() {\n        this._$search = $('#search_field').rbautocomplete({\n            formatItem: data => {\n                let s;\n\n                if (data.username) {\n                    // For the format of users:\n                    s = data.username;\n\n                    if (data.fullname) {\n                        s += ` <span>(${_.escape(data.fullname)})</span>`;\n                    }\n\n                } else if (data.name) {\n                    // For the format of groups:\n                    const displayName = _.escape(data.display_name);\n                    s = `${data.name} <span>(${displayName})</span>`;\n                } else if (data.summary) {\n                    // For the format of review requests:\n                    if (data.summary.length < this.SEARCH_SUMMARY_TRIM_LEN) {\n                        s = data.summary;\n                    } else {\n                        s = data.summary.substring(\n                            0, this.SEARCH_SUMMARY_TRIM_LEN);\n                    }\n\n                    s += ` <span>(${_.escape(data.id)})</span>`;\n                }\n\n                return s;\n            },\n            matchCase: false,\n            multiple: false,\n            clickToURL: true,\n            selectFirst: false,\n            width: this.DESKTOP_SEARCH_RESULTS_WIDTH,\n            enterToURL: true,\n            resultsParentEl: $('#page-container'),\n            resultsClass: 'ui-autocomplete-results search-results',\n            parse: data => {\n                const objects = ['users', 'groups', 'review_requests'];\n                const keys = ['username', 'name', 'summary'];\n\n                const parsed = [];\n\n                for (let j = 0; j < objects.length; j++) {\n                    const object = objects[j];\n                    const items = data.search[object];\n\n                    for (let i = 0; i < items.length; i++) {\n                        const value = items[i];\n                        const key = keys[j];\n\n\n                        if (j !== 2) {\n                            // For users and groups, always show.\n                            parsed.push({\n                                data: value,\n                                value: value[key],\n                                result: value[key],\n                            });\n                        } else if (value.public) {\n                            /*\n                             * For review requests, only show ones that are\n                             * public.\n                             */\n                            parsed.push({\n                                data: value,\n                                value: value[key],\n                                result: value[key],\n                            });\n                        }\n                    }\n                }\n\n                return parsed;\n            },\n            url: `${SITE_ROOT}api/search/`,\n            extraParams: {\n                'only-fields': 'display_name,fullname,id,name,public,summary,url,username',\n                'only-links': '',\n            },\n        });\n    },\n\n    /**\n     * Set whether the mobile menu is opened.\n     *\n     * Args:\n     *     opened (boolean):\n     *         Whether the menu is open.\n     */\n    _setMobileMenuOpened(opened) {\n        if (opened === this._mobileMenuOpened) {\n            return;\n        }\n\n        if (opened) {\n            this._$mobileMenuMask.show();\n            _.defer(() => this._$body.addClass('js-mobile-menu-open'));\n        } else {\n            this._$body.removeClass('js-mobile-menu-open');\n            _.delay(() => this._$mobileMenuMask.hide(), 300);\n        }\n\n        this._mobileMenuOpened = opened;\n    },\n}, {\n    /** The instance of the HeaderView. */\n    instance: null,\n});\n"],"mappings":"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"}