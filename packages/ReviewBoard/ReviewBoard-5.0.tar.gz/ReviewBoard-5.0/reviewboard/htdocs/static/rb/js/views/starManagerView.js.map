{"version":3,"file":"starManagerView.js","names":["RB","StarManagerView","Backbone","View","extend","initialize","options","objects","model","get","starred","_datagridMode","datagridMode","$","on","_toggleStar","bind","each","idx","el","$el","objType","attr","objID","objStarred","parseInt","obj","ReviewRequest","id","ReviewGroup","undefined","console","assert","_watchUpdates","_toUpdate","$grid","mode","hasOwnProperty","_updateStarColumn","toggleClass","e","$target","target","preventDefault","stopPropagation","UserSession","instance","setStarred"],"sources":["../../../../../static/rb/js/views/starManagerView.es6.js"],"sourcesContent":["/**\n * A manager for star buttons, for both datagrids and individual buttons.\n *\n * This view manages the state of review request and review group star status\n * in datagrids, as well as the star status for review requests on their\n * individual pages.\n */\nRB.StarManagerView = Backbone.View.extend({\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object, optional):\n     *         View initialization options.\n     *\n     * Option Args:\n     *     datagridMode (boolean):\n     *         Whether or not the manager is managing a datagrid.\n     */\n    initialize(options={}) {\n        const objects = this.model.get('objects');\n        const starred = this.model.get('starred');\n\n        this._datagridMode = options.datagridMode;\n\n        /*\n         * This doesn't use the view's events object to bind to _toggleStar\n         * because doing so interferes with event bubbling and handler order.\n         * We need the datagrid's click handler to run after this one, so we\n         * bind directly to the element rather than on the parent view.\n         */\n        this.$('div.star')\n            .on('click', this._toggleStar.bind(this))\n            .each((idx, el) => {\n            const $el = $(el);\n            const objType = $el.attr('data-object-type');\n            const objID = $el.attr('data-object-id');\n            const objStarred = (parseInt($el.attr('data-starred'), 10) === 1);\n            let obj;\n\n            if (objType === 'reviewrequests') {\n                obj = new RB.ReviewRequest({ id: objID });\n            } else if (objType === 'groups') {\n                obj = new RB.ReviewGroup({ id: objID });\n            } else if (objType !== undefined) {\n                console.assert('Unknown star object type: %s', objType);\n            } else {\n                /* Skip any stars that don't have an object type. */\n                return;\n            }\n\n            objects[objID] = obj;\n            starred[objID] = objStarred;\n        });\n\n        /*\n         * When the datagrid is in mobile mode, we have to keep track of any\n         * objects whose star status changes so that we can update the datagrid\n         * if it switches back to desktop mode.\n         */\n        this._watchUpdates = false;\n        this._toUpdate = {};\n\n        if (this._datagridMode) {\n            this.$el.on('datagridDisplayModeChanged', ($grid, options) => {\n                if (options.mode === 'desktop') {\n                    for (let objID in this._toUpdate) {\n                        if (this._toUpdate.hasOwnProperty(objID)) {\n                            this._updateStarColumn(objID);\n                        }\n                    }\n\n                    this._watchUpdates = false;\n                    this._toUpdate = {};\n                } else if (options.mode === 'mobile') {\n                    this._watchUpdates = true;\n                }\n            });\n\n            if (this.$el.attr('data-datagrid-display-mode') === 'mobile') {\n                this._watchUpdates = true;\n            }\n        }\n    },\n\n    /**\n     * Update a star column.\n     *\n     * This function is called when the datagrid changes from mobile to desktop\n     * model. Since datagrids copy the original DOM over the new one when the\n     * mode is changed to desktop, we must copy over relevant star attributes\n     * and classes when this happens.\n     *\n     * Args:\n     *     objID (string):\n     *         The object's unique ID, as a string.\n     */\n    _updateStarColumn(objID) {\n        const $el = this.$(`.star[data-object-id=\"${objID}\"]`);\n        const starred = this.model.get('starred')[objID];\n\n        $el\n            .toggleClass('rb-icon-star-on', starred)\n            .toggleClass('rb-icon-star-off', !starred)\n            .attr('title',\n                  starred ? gettext('Starred')\n                          : gettext('Click to star'));\n    },\n\n    /**\n     * Toggle an object being starred or unstarred.\n     *\n     * This function is called when a star icon is clicked.\n     *\n     * Args:\n     *     e (Event):\n     *         The click event.\n     */\n    _toggleStar(e) {\n        const $target = $(e.target);\n        const objID = $target.attr('data-object-id');\n        const obj = this.model.get('objects')[objID];\n        const starred = this.model.get('starred');\n        const objStarred = !starred[objID];\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (RB.UserSession.instance.get('readOnly')) {\n            return;\n        }\n\n        obj.setStarred(objStarred);\n        starred[objID] = objStarred;\n\n        if (this._watchUpdates) {\n            if (this._toUpdate.hasOwnProperty(objID)) {\n                delete this._toUpdate[objID];\n            } else {\n                this._toUpdate[objID] = true;\n            }\n        }\n\n        $target\n            .toggleClass('rb-icon-star-on', objStarred)\n            .toggleClass('rb-icon-star-off', !objStarred)\n            .attr('title',\n                  objStarred ? gettext('Starred')\n                             : gettext('Click to star'));\n    },\n});\n"],"mappings":"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"}