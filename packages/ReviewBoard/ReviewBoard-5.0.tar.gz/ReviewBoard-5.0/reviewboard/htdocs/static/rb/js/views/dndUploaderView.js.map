{"version":3,"file":"dndUploaderView.js","names":["DnDDropTarget","Backbone","Model","extend","defaults","$target","$","window","callback","dropText","DnDDropOverlayView","View","className","events","render","$el","text","model","get","show","addClass","_","defer","offset","width","outerWidth","height","outerHeight","css","left","top","hide","removeClass","close","fadeOut","trigger","remove","_onDrop","e","stopPropagation","preventDefault","dt","originalEvent","dataTransfer","files","file","Array","from","_onDragEnter","dropEffect","_onDragOver","_onDragLeave","RB","DnDUploader","initialize","_dropTargets","Collection","_dropOverlays","_hideOverlayTimeout","_overlaysVisible","_overlaysHiding","bindAll","on","_showOverlays","_hideOverlays","registerDropTarget","findWhere","undefined","target","add","overlay","appendTo","document","body","listenTo","push","console","error","unregisterDropTarget","overlayIx","findIndex","splice","types","includes","forEach","clearTimeout","setTimeout","instance","create","assert"],"sources":["../../../../../static/rb/js/views/dndUploaderView.es6.js"],"sourcesContent":["(function() {\n\n\n/**\n * A model for creating drag and drop targets.\n *\n * Registering a RB.DnDDropTarget with the RB.DnDUploader will create an\n * overlay on top of the target when files are dragged over the page. This\n * overlay will accept dropped files and run the dropAction for each file\n * dropped on it.\n *\n * Model Attributes:\n *     $target (jQuery):\n *         The target element to allow file drops on.\n *\n *     callback (function):\n *         The function to call when a file is dropped.\n *\n *     dropText (string):\n *         The string to show in the overlay.\n */\nconst DnDDropTarget = Backbone.Model.extend({\n    defaults() {\n        return {\n            $target: $(window),\n            callback: function() {},\n            dropText: gettext('Drop to upload')\n        };\n    }\n});\n\n\n/**\n * Displays an overlay over an element that accepts file drops.\n *\n * The overlay appears as semi-transparent black with the dropText message in\n * the center.\n *\n * If the user cancels the drop or moves the mouse out of the page, the\n * overlay will fade away.\n */\nconst DnDDropOverlayView = Backbone.View.extend({\n    className: 'dnd-overlay',\n\n    events: {\n        'dragenter': '_onDragEnter',\n        'dragover': '_onDragOver',\n        'dragleave': '_onDragLeave',\n        'drop': '_onDrop'\n    },\n\n    /**\n     * Render the view.\n     *\n     * Returns:\n     *     DnDDropOverlayView:\n     *     This object, for chaining.\n     */\n    render() {\n        this.$el.text(this.model.get('dropText'));\n\n        return this;\n    },\n\n    /**\n     * Show the overlay.\n     */\n    show() {\n        const $target = this.model.get('$target');\n        $target.addClass('dnd-overlay-visible');\n\n        /*\n         * Adding the class to the target may change its visibility or size.\n         * Let that clear before trying to position/size the overlay.\n         */\n        _.defer(() => {\n            const offset = $target.offset();\n            const width = $target.outerWidth() + 'px';\n            const height = $target.outerHeight() + 'px';\n\n            this.$el\n                .css({\n                    width: width,\n                    height: height,\n                    'line-height': height,\n                    left: offset.left + 'px',\n                    top: offset.top + 'px'\n                })\n                .show();\n        });\n    },\n\n    /**\n     * Hide the overlay.\n     */\n    hide() {\n        this.model.get('$target').removeClass('dnd-overlay-visible');\n        this.$el.hide();\n    },\n\n    /**\n     * Close the overlay.\n     *\n     * The overlay will fade out, and once it's gone, it will emit the \"closed\"\n     * event and remove itself from the page.\n     */\n    close() {\n        this.$el.fadeOut(() => {\n            this.trigger('closed');\n            this.remove();\n        });\n    },\n\n    /**\n     * Handle drop events on the overlay.\n     *\n     * This will call the appropriate callback for all dropped files.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event that triggered the callback.\n     */\n    _onDrop(e) {\n        e.stopPropagation();\n        e.preventDefault();\n\n        const dt = e.originalEvent.dataTransfer;\n        const files = dt && dt.files;\n\n        if (files) {\n            const callback = this.model.get('callback');\n\n            for (let file of Array.from(files)) {\n                callback(file);\n            }\n        }\n\n        this.trigger('closing');\n    },\n\n    /**\n     * Handle dragenter events on the overlay.\n     *\n     * If there's files being dragged, the drop effect (usually represented\n     * by a mouse cursor) will be set to indicate a copy of the files.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event that triggered the callback.\n     */\n    _onDragEnter(e) {\n        e.preventDefault();\n\n        const dt = e.originalEvent.dataTransfer;\n\n        if (dt) {\n            dt.dropEffect = 'copy';\n            this.$el.addClass('dnd-overlay-highlight');\n        }\n    },\n\n    /**\n     * Handle dragover events on the overlay.\n     *\n     * This merely prevents the default action, which indicates to the\n     * underlying API that this element can be dropped on.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event which triggered the callback.\n     */\n    _onDragOver(e) {\n        e.preventDefault();\n    },\n\n    /**\n     * Handle dragleave events on the overlay.\n     *\n     * If there were files previously being dragged over the overlay,\n     * the drop effect will be reset.\n     *\n     * The overlay is always closed on a dragleave.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event that triggered the callback.\n     */\n    _onDragLeave(e) {\n        e.preventDefault();\n\n        const dt = e.originalEvent.dataTransfer;\n\n        if (dt) {\n            dt.dropEffect = 'none';\n            this.$el.removeClass('dnd-overlay-highlight');\n        }\n    }\n});\n\n\n/*\n * Handles drag-and-drop file uploads for a review request.\n *\n * This makes it possible to drag files from a file manager and drop them\n * into Review Board. This requires browser support for HTML 5 file\n * drag-and-drop, which is available in most modern browsers.\n *\n * The moment the DnDUploader is created, it will begin listening for\n * DnD-related events on the window.\n */\nRB.DnDUploader = Backbone.View.extend({\n    /**\n     * Initialize the view.\n     */\n    initialize() {\n        this._dropTargets = new Backbone.Collection({\n            model: DnDDropTarget\n        });\n        this._dropOverlays = [];\n        this._hideOverlayTimeout = null;\n        this._overlaysVisible = false;\n        this._overlaysHiding = false;\n\n        _.bindAll(this, '_showOverlays', '_hideOverlays');\n\n        $(window)\n            .on('dragstart dragenter dragover', this._showOverlays)\n            .on('dragend dragleave', this._hideOverlays);\n    },\n\n    /**\n     * Register a new drop target.\n     *\n     * Args:\n     *     $target (jQuery):\n     *         The target element for drops.\n     *\n     *     dropText (string):\n     *         The text to show on the overlay.\n     *\n     *     callback (function):\n     *         The function to call when a file is dropped. This takes a single\n     *         file argument, and will be called for each file that is dropped\n     *         on the target.\n     */\n    registerDropTarget($target, dropText, callback) {\n        if (this._dropTargets.findWhere({ $target }) === undefined) {\n            const target = new DnDDropTarget({\n                $target,\n                dropText,\n                callback\n            });\n            this._dropTargets.add(target);\n\n            const overlay = new DnDDropOverlayView({\n                model: target\n            });\n\n            overlay.render().$el\n                .hide()\n                .appendTo(document.body);\n            this.listenTo(overlay, 'closing', this._hideOverlays);\n\n            this._dropOverlays.push(overlay);\n        } else {\n            console.error('Drop target was already registered!', $target);\n        }\n    },\n\n    /**\n     * Unregister an existing drop target.\n     *\n     * Args:\n     *     $target (jQuery):\n     *         The target element for drops.\n     */\n    unregisterDropTarget($target) {\n        const target = this._dropTargets.findWhere({ $target: $target });\n        const overlayIx = this._dropOverlays.findIndex(\n            overlay => (overlay.model === target));\n\n        if (overlayIx !== -1) {\n            this._dropOverlays[overlayIx].remove();\n            this._dropOverlays.splice(overlayIx, 1);\n        }\n\n        if (target !== undefined) {\n            this._dropTargets.remove(target);\n        }\n    },\n\n    /**\n     * Show the drop overlays.\n     *\n     * An overlay will be displayed over all the registered drop targets to\n     * give the user a place to drop the files onto. The overlay will report\n     * any files dropped.\n     *\n     * Args:\n     *     e (DragEvent):\n     *         The event that triggered the callback.\n     */\n    _showOverlays(e) {\n        if (e.originalEvent.dataTransfer !== undefined &&\n            Array.from(e.originalEvent.dataTransfer.types).includes('Files')) {\n            this._overlaysHiding = false;\n\n            if (!this._overlaysVisible) {\n                this._overlaysVisible = true;\n                this._dropOverlays.forEach(overlay => overlay.show());\n            }\n        }\n    },\n\n    /**\n     * Hide the drop overlays.\n     */\n    _hideOverlays() {\n        /*\n         * This will get called many times because the event bubbles up from\n         * all the children of the document. We only want to hide the overlays\n         * when the drag exits the window.\n         *\n         * In order to make this work reliably, we only hide the overlays after\n         * a timeout (to make sure there's not a dragenter event coming\n         * immediately after this).\n         */\n        if (this._hideOverlayTimeout) {\n            clearTimeout(this._hideOverlayTimeout);\n        }\n\n        this._overlaysHiding = true;\n        this._hideOverlayTimeout = setTimeout(() => {\n            if (this._overlaysHiding) {\n                this._overlaysVisible = false;\n                this._dropOverlays.forEach(overlay => overlay.hide());\n            }\n        }, 200);\n    }\n}, {\n    instance: null,\n\n    /**\n     * Create the DnDUploader instance.\n     *\n     * Returns:\n     *     RB.DnDUploader:\n     *     The new instance.\n     */\n    create() {\n        console.assert(RB.DnDUploader.instance === null,\n                       'DnDUploader.create may only be called once');\n\n        RB.DnDUploader.instance = new RB.DnDUploader();\n        return RB.DnDUploader.instance;\n    }\n});\n\n\n})();\n"],"mappings":";;AAAA,CAAC,YAAW;EAGZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACA,MAAMA,aAAa,GAAGC,QAAQ,CAACC,KAAT,CAAeC,MAAf,CAAsB;IACxCC,QAAQ,GAAG;MACP,OAAO;QACHC,OAAO,EAAEC,CAAC,CAACC,MAAD,CADP;QAEHC,QAAQ,EAAE,YAAW,CAAE,CAFpB;QAGHC,QAAQ;MAHL,CAAP;IAKH;;EAPuC,CAAtB,CAAtB;EAWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;EACA,MAAMC,kBAAkB,GAAGT,QAAQ,CAACU,IAAT,CAAcR,MAAd,CAAqB;IAC5CS,SAAS,EAAE,aADiC;IAG5CC,MAAM,EAAE;MACJ,aAAa,cADT;MAEJ,YAAY,aAFR;MAGJ,aAAa,cAHT;MAIJ,QAAQ;IAJJ,CAHoC;;IAU5C;AACJ;AACA;AACA;AACA;AACA;AACA;IACIC,MAAM,GAAG;MACL,KAAKC,GAAL,CAASC,IAAT,CAAc,KAAKC,KAAL,CAAWC,GAAX,CAAe,UAAf,CAAd;MAEA,OAAO,IAAP;IACH,CArB2C;;IAuB5C;AACJ;AACA;IACIC,IAAI,GAAG;MACH,MAAMd,OAAO,GAAG,KAAKY,KAAL,CAAWC,GAAX,CAAe,SAAf,CAAhB;MACAb,OAAO,CAACe,QAAR,CAAiB,qBAAjB;MAEA;AACR;AACA;AACA;;MACQC,CAAC,CAACC,KAAF,CAAQ,MAAM;QACV,MAAMC,MAAM,GAAGlB,OAAO,CAACkB,MAAR,EAAf;QACA,MAAMC,KAAK,GAAGnB,OAAO,CAACoB,UAAR,KAAuB,IAArC;QACA,MAAMC,MAAM,GAAGrB,OAAO,CAACsB,WAAR,KAAwB,IAAvC;QAEA,KAAKZ,GAAL,CACKa,GADL,CACS;UACDJ,KAAK,EAAEA,KADN;UAEDE,MAAM,EAAEA,MAFP;UAGD,eAAeA,MAHd;UAIDG,IAAI,EAAEN,MAAM,CAACM,IAAP,GAAc,IAJnB;UAKDC,GAAG,EAAEP,MAAM,CAACO,GAAP,GAAa;QALjB,CADT,EAQKX,IARL;MASH,CAdD;IAeH,CAjD2C;;IAmD5C;AACJ;AACA;IACIY,IAAI,GAAG;MACH,KAAKd,KAAL,CAAWC,GAAX,CAAe,SAAf,EAA0Bc,WAA1B,CAAsC,qBAAtC;MACA,KAAKjB,GAAL,CAASgB,IAAT;IACH,CAzD2C;;IA2D5C;AACJ;AACA;AACA;AACA;AACA;IACIE,KAAK,GAAG;MACJ,KAAKlB,GAAL,CAASmB,OAAT,CAAiB,MAAM;QACnB,KAAKC,OAAL,CAAa,QAAb;QACA,KAAKC,MAAL;MACH,CAHD;IAIH,CAtE2C;;IAwE5C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIC,OAAO,CAACC,CAAD,EAAI;MACPA,CAAC,CAACC,eAAF;MACAD,CAAC,CAACE,cAAF;MAEA,MAAMC,EAAE,GAAGH,CAAC,CAACI,aAAF,CAAgBC,YAA3B;MACA,MAAMC,KAAK,GAAGH,EAAE,IAAIA,EAAE,CAACG,KAAvB;;MAEA,IAAIA,KAAJ,EAAW;QACP,MAAMpC,QAAQ,GAAG,KAAKS,KAAL,CAAWC,GAAX,CAAe,UAAf,CAAjB;;QAEA,KAAK,IAAI2B,IAAT,IAAiBC,KAAK,CAACC,IAAN,CAAWH,KAAX,CAAjB,EAAoC;UAChCpC,QAAQ,CAACqC,IAAD,CAAR;QACH;MACJ;;MAED,KAAKV,OAAL,CAAa,SAAb;IACH,CAjG2C;;IAmG5C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIa,YAAY,CAACV,CAAD,EAAI;MACZA,CAAC,CAACE,cAAF;MAEA,MAAMC,EAAE,GAAGH,CAAC,CAACI,aAAF,CAAgBC,YAA3B;;MAEA,IAAIF,EAAJ,EAAQ;QACJA,EAAE,CAACQ,UAAH,GAAgB,MAAhB;QACA,KAAKlC,GAAL,CAASK,QAAT,CAAkB,uBAAlB;MACH;IACJ,CAtH2C;;IAwH5C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACI8B,WAAW,CAACZ,CAAD,EAAI;MACXA,CAAC,CAACE,cAAF;IACH,CApI2C;;IAsI5C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIW,YAAY,CAACb,CAAD,EAAI;MACZA,CAAC,CAACE,cAAF;MAEA,MAAMC,EAAE,GAAGH,CAAC,CAACI,aAAF,CAAgBC,YAA3B;;MAEA,IAAIF,EAAJ,EAAQ;QACJA,EAAE,CAACQ,UAAH,GAAgB,MAAhB;QACA,KAAKlC,GAAL,CAASiB,WAAT,CAAqB,uBAArB;MACH;IACJ;;EA3J2C,CAArB,CAA3B;EA+JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;EACAoB,EAAE,CAACC,WAAH,GAAiBpD,QAAQ,CAACU,IAAT,CAAcR,MAAd,CAAqB;IAClC;AACJ;AACA;IACImD,UAAU,GAAG;MACT,KAAKC,YAAL,GAAoB,IAAItD,QAAQ,CAACuD,UAAb,CAAwB;QACxCvC,KAAK,EAAEjB;MADiC,CAAxB,CAApB;MAGA,KAAKyD,aAAL,GAAqB,EAArB;MACA,KAAKC,mBAAL,GAA2B,IAA3B;MACA,KAAKC,gBAAL,GAAwB,KAAxB;MACA,KAAKC,eAAL,GAAuB,KAAvB;;MAEAvC,CAAC,CAACwC,OAAF,CAAU,IAAV,EAAgB,eAAhB,EAAiC,eAAjC;;MAEAvD,CAAC,CAACC,MAAD,CAAD,CACKuD,EADL,CACQ,8BADR,EACwC,KAAKC,aAD7C,EAEKD,EAFL,CAEQ,mBAFR,EAE6B,KAAKE,aAFlC;IAGH,CAlBiC;;IAoBlC;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIC,kBAAkB,CAAC5D,OAAD,EAAUI,QAAV,EAAoBD,QAApB,EAA8B;MAC5C,IAAI,KAAK+C,YAAL,CAAkBW,SAAlB,CAA4B;QAAE7D;MAAF,CAA5B,MAA6C8D,SAAjD,EAA4D;QACxD,MAAMC,MAAM,GAAG,IAAIpE,aAAJ,CAAkB;UAC7BK,OAD6B;UAE7BI,QAF6B;UAG7BD;QAH6B,CAAlB,CAAf;;QAKA,KAAK+C,YAAL,CAAkBc,GAAlB,CAAsBD,MAAtB;;QAEA,MAAME,OAAO,GAAG,IAAI5D,kBAAJ,CAAuB;UACnCO,KAAK,EAAEmD;QAD4B,CAAvB,CAAhB;QAIAE,OAAO,CAACxD,MAAR,GAAiBC,GAAjB,CACKgB,IADL,GAEKwC,QAFL,CAEcC,QAAQ,CAACC,IAFvB;QAGA,KAAKC,QAAL,CAAcJ,OAAd,EAAuB,SAAvB,EAAkC,KAAKN,aAAvC;;QAEA,KAAKP,aAAL,CAAmBkB,IAAnB,CAAwBL,OAAxB;MACH,CAlBD,MAkBO;QACHM,OAAO,CAACC,KAAR,CAAc,qCAAd,EAAqDxE,OAArD;MACH;IACJ,CAzDiC;;IA2DlC;AACJ;AACA;AACA;AACA;AACA;AACA;IACIyE,oBAAoB,CAACzE,OAAD,EAAU;MAC1B,MAAM+D,MAAM,GAAG,KAAKb,YAAL,CAAkBW,SAAlB,CAA4B;QAAE7D,OAAO,EAAEA;MAAX,CAA5B,CAAf;;MACA,MAAM0E,SAAS,GAAG,KAAKtB,aAAL,CAAmBuB,SAAnB,CACdV,OAAO,IAAKA,OAAO,CAACrD,KAAR,KAAkBmD,MADhB,CAAlB;;MAGA,IAAIW,SAAS,KAAK,CAAC,CAAnB,EAAsB;QAClB,KAAKtB,aAAL,CAAmBsB,SAAnB,EAA8B3C,MAA9B;;QACA,KAAKqB,aAAL,CAAmBwB,MAAnB,CAA0BF,SAA1B,EAAqC,CAArC;MACH;;MAED,IAAIX,MAAM,KAAKD,SAAf,EAA0B;QACtB,KAAKZ,YAAL,CAAkBnB,MAAlB,CAAyBgC,MAAzB;MACH;IACJ,CA/EiC;;IAiFlC;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIL,aAAa,CAACzB,CAAD,EAAI;MACb,IAAIA,CAAC,CAACI,aAAF,CAAgBC,YAAhB,KAAiCwB,SAAjC,IACArB,KAAK,CAACC,IAAN,CAAWT,CAAC,CAACI,aAAF,CAAgBC,YAAhB,CAA6BuC,KAAxC,EAA+CC,QAA/C,CAAwD,OAAxD,CADJ,EACsE;QAClE,KAAKvB,eAAL,GAAuB,KAAvB;;QAEA,IAAI,CAAC,KAAKD,gBAAV,EAA4B;UACxB,KAAKA,gBAAL,GAAwB,IAAxB;;UACA,KAAKF,aAAL,CAAmB2B,OAAnB,CAA2Bd,OAAO,IAAIA,OAAO,CAACnD,IAAR,EAAtC;QACH;MACJ;IACJ,CAtGiC;;IAwGlC;AACJ;AACA;IACI6C,aAAa,GAAG;MACZ;AACR;AACA;AACA;AACA;AACA;AACA;AACA;AACA;MACQ,IAAI,KAAKN,mBAAT,EAA8B;QAC1B2B,YAAY,CAAC,KAAK3B,mBAAN,CAAZ;MACH;;MAED,KAAKE,eAAL,GAAuB,IAAvB;MACA,KAAKF,mBAAL,GAA2B4B,UAAU,CAAC,MAAM;QACxC,IAAI,KAAK1B,eAAT,EAA0B;UACtB,KAAKD,gBAAL,GAAwB,KAAxB;;UACA,KAAKF,aAAL,CAAmB2B,OAAnB,CAA2Bd,OAAO,IAAIA,OAAO,CAACvC,IAAR,EAAtC;QACH;MACJ,CALoC,EAKlC,GALkC,CAArC;IAMH;;EAhIiC,CAArB,EAiId;IACCwD,QAAQ,EAAE,IADX;;IAGC;AACJ;AACA;AACA;AACA;AACA;AACA;IACIC,MAAM,GAAG;MACLZ,OAAO,CAACa,MAAR,CAAerC,EAAE,CAACC,WAAH,CAAekC,QAAf,KAA4B,IAA3C,EACe,4CADf;MAGAnC,EAAE,CAACC,WAAH,CAAekC,QAAf,GAA0B,IAAInC,EAAE,CAACC,WAAP,EAA1B;MACA,OAAOD,EAAE,CAACC,WAAH,CAAekC,QAAtB;IACH;;EAhBF,CAjIc,CAAjB;AAqJC,CAvWD"}