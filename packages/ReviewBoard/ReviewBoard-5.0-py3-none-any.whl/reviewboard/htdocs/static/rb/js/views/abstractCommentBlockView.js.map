{"version":3,"file":"abstractCommentBlockView.js","names":["RB","AbstractCommentBlockView","Backbone","View","extend","events","tooltipSides","dispose","trigger","remove","_$tooltip","render","$","tooltip","$el","side","addClass","renderContent","model","on","_onDraftCommentChanged","_updateTooltip","hideTooltip","hide","positionCommentDlg","commentDlg","positionBeside","fitOnScreen","positionNotifyBubble","$bubble","move","Math","round","width","height","notify","text","cb","context","css","appendTo","animate","top","opacity","delay","_","isFunction","call","$list","draftComment","get","tooltipTemplate","template","user","UserSession","instance","html","forEach","comment","name","empty","append","removeClass","isEmpty","fadeOut","options","boundsUpdated","DraftReviewBannerView","show","_onClicked"],"sources":["../../../../../static/rb/js/views/abstractCommentBlockView.es6.js"],"sourcesContent":["RB.AbstractCommentBlockView = Backbone.View.extend({\n    events: {\n        'click': '_onClicked'\n    },\n\n    tooltipSides: 'lrbt',\n\n    /**\n     * Dispose the comment block.\n     *\n     * This will remove the view and the tooltip.\n     */\n    dispose() {\n        this.trigger('removing');\n        this.remove();\n        this._$tooltip.remove();\n    },\n\n    /**\n     * Render the comment block.\n     *\n     * Along with the block, a floating tooltip will be created that\n     * displays summaries of the comments.\n     *\n     * Returns:\n     *     RB.AbstractCommentBlockView:\n     *     This object, for chaining.\n     */\n    render() {\n        this._$tooltip = $.tooltip(this.$el, { side: this.tooltipSides })\n            .addClass('comments');\n\n        this.renderContent();\n\n        this.model.on('change:draftComment', this._onDraftCommentChanged, this);\n        this._onDraftCommentChanged();\n\n        this._updateTooltip();\n\n        return this;\n    },\n\n    /**\n     * Hide the tooltip from the page.\n     *\n     * This will force the tooltip to hide, preventing it from interfering\n     * with operations such as moving a comment block.\n     *\n     * It will automatically show again the next time there is a mouse enter\n     * event.\n     */\n    hideTooltip() {\n        this._$tooltip.hide();\n    },\n\n    /**\n     * Position the comment dlg to the right side of comment block.\n     *\n     * This can be overridden to change where the comment dialog will\n     * be displayed.\n     *\n     * Args:\n     *     commntDlg (RB.CommentDialogView):\n     *          The view for the comment dialog.\n     */\n    positionCommentDlg(commentDlg) {\n        commentDlg.positionBeside(this.$el, {\n            side: 'r',\n            fitOnScreen: true\n        });\n    },\n\n    /**\n     * Position the notification bubble around the comment block.\n     *\n     * This can be overridden to change where the bubble will be displayed.\n     * By default, it is centered over the block.\n     *\n     * Args:\n     *     $bubble (jQuery):\n     *         The selector for the notification bubble.\n     */\n    positionNotifyBubble($bubble) {\n        $bubble.move(Math.round((this.$el.width()  - $bubble.width())  / 2),\n                     Math.round((this.$el.height() - $bubble.height()) / 2));\n    },\n\n    /**\n     * Notify the user of some update.\n     *\n     * This notification appears in the comment area.\n     *\n     * Args:\n     *     text (string):\n     *         The text to show in the notification.\n     *\n     *     cb (function, optional):\n     *         A callback function to call once the notification has been\n     *         removed.\n     *\n     *     context (object):\n     *         Context to bind when calling the ``cb`` callback function.\n     */\n    notify(text, cb, context) {\n        const $bubble = $('<div class=\"bubble\">')\n            .css('opacity', 0)\n            .appendTo(this.$el)\n            .text(text);\n\n        this.positionNotifyBubble($bubble);\n\n        $bubble\n            .animate({\n                top: '-=10px',\n                opacity: 0.8,\n            }, 350, 'swing')\n            .delay(1200)\n            .animate({\n                top: '+=10px',\n                opacity: 0,\n            }, 350, 'swing', () => {\n                $bubble.remove();\n\n                if (_.isFunction(cb)) {\n                    cb.call(context);\n                }\n            });\n    },\n\n    /**\n     * Update the tooltip contents.\n     *\n     * The contents will show the summary of each comment, including\n     * the draft comment, if any.\n     */\n    _updateTooltip() {\n        const $list = $('<ul/>');\n        const draftComment = this.model.get('draftComment');\n        const tooltipTemplate = _.template(dedent`\n            <li>\n             <div class=\"reviewer\">\n              <%- user %>:\n             </div>\n             <pre class=\"rich-text\"><%= html %></pre>\n            </li>\n        `);\n\n        if (draftComment) {\n            $(tooltipTemplate({\n                user: RB.UserSession.instance.get('fullName'),\n                html: draftComment.get('html'),\n            }))\n            .addClass('draft')\n            .appendTo($list);\n        }\n\n        this.model.get('serializedComments').forEach(comment => {\n            $(tooltipTemplate({\n                user: comment.user.name,\n                html: comment.html,\n            }))\n            .appendTo($list);\n        });\n\n        this._$tooltip\n            .empty()\n            .append($list);\n    },\n\n    /**\n     * Handle changes to the model's draftComment property.\n     *\n     * If there's a new draft comment, we'll begin listening for updates\n     * on it in order to update the tooltip or display notification bubbles.\n     *\n     * The comment block's style will reflect whether or not we have a\n     * draft comment.\n     *\n     * If the draft comment is deleted, and there are no other comments,\n     * the view will be removed.\n     */\n    _onDraftCommentChanged() {\n        const comment = this.model.get('draftComment');\n\n        if (!comment) {\n            this.$el.removeClass('draft');\n            return;\n        }\n\n        comment.on('change:text', this._updateTooltip, this);\n\n        comment.on('destroy', () => {\n            this.notify(gettext('Comment Deleted'), () => {\n                // Discard the comment block if empty.\n                if (this.model.isEmpty()) {\n                    this.$el.fadeOut(350, () => this.dispose());\n                } else {\n                    this.$el.removeClass('draft');\n                    this._updateTooltip();\n                }\n            });\n        });\n\n        comment.on('saved', options => {\n            this._updateTooltip();\n\n            if (!options.boundsUpdated) {\n                this.notify(gettext('Comment Saved'));\n            }\n\n            RB.DraftReviewBannerView.instance.show();\n        });\n\n        this.$el.addClass('draft');\n    },\n\n    /**\n     * Handle the comment block being clicked.\n     *\n     * Emits the 'clicked' signal so that parent views can process it.\n     */\n    _onClicked() {\n        this.trigger('clicked');\n    },\n});\n"],"mappings":"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"}