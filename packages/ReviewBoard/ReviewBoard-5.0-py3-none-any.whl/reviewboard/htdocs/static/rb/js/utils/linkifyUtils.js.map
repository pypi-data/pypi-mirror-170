{"version":3,"file":"linkifyUtils.js","names":["RB","LinkifyUtils","URL_RE","RegExp","join","linkifyURLs","text","replace","url","parts","match","openParen","extra","linkifyReviewRequests","m1","m2","href","SITE_ROOT","substr","linkifyBugs","bugTrackerURL","m3","bugnum1","bugnum2","bugnum","linkifyText","isHTMLEncoded","htmlEncode","linkifyChildren","el","i","childNodes","length","node","nodeType","TEXT_NODE","textContent","newText","$","replaceWith","ELEMENT_NODE","nodeName"],"sources":["../../../../../static/rb/js/utils/linkifyUtils.es6.js"],"sourcesContent":["RB.LinkifyUtils = {\n    URL_RE: new RegExp(\n        '\\\\b((' + [\n            'https://',\n            'http://',\n            'ftp://',\n            'ftps://',\n            'gopher://',\n            'mailto:',\n            'news:',\n            'sms:'\n        ].join('|') +\n        ')[\\\\-A-Za-z0-9+&@#\\/%?=~_()|!:,.;]*([\\\\-A-Za-z0-9+@#\\/%=~_();|]|))',\n        'g'\n    ),\n\n    /**\n     * Linkify all URLs within some text.\n     *\n     * This will turn things that look like URLs into clickable links.\n     *\n     * Args:\n     *     text (string):\n     *         The text to linkify.\n     *\n     * Returns:\n     *     string:\n     *     The given text with all URLs replaced by <a> tags.\n     */\n    linkifyURLs(text) {\n        return text.replace(\n            RB.LinkifyUtils.URL_RE,\n            function(url) {\n                /*\n                 * We might catch an entity at the end of the URL. This is hard\n                 * to avoid, since we can't rely on advanced RegExp techniques\n                 * in all browsers. So, we'll now search for it and prevent it\n                 * from being part of the URL if it exists. However, a URL with\n                 * an open bracket will not have its close bracket removed. This\n                 * was a modification to the original bug fix.\n                 *\n                 * See bug 1069.\n                 */\n                const parts = url.match(/^(.*)(&[a-z]+;|\\))$/);\n                const openParen = url.match(/.*\\(.*/);\n\n                let extra = '';\n\n                if (parts !== null && openParen === null) {\n                    /* We caught an entity. Set it free. */\n                    url = parts[1];\n                    extra = parts[2];\n                }\n\n                return `<a target=\"_blank\" href=\"${url}\">${url}</a>${extra}`;\n            });\n    },\n\n    /**\n     * Linkify /r/# review request numbers.\n     *\n     * This will turn things that look like references to other review requests\n     * into clickable links.\n     *\n     * Args:\n     *     text (string):\n     *         The text to linkify.\n     *\n     * Returns:\n     *     string:\n     *     The given text with all \"/r/#\" text replaced by <a> tags.\n     */\n    linkifyReviewRequests(text) {\n        return text.replace(\n            /(^|\\s|&lt;|\\(|\\[|{)\\/(r\\/\\d+(\\/[\\-A-Za-z0-9+&@#\\/%?=~_()|!:,.;]*[\\-A-Za-z0-9+&@#\\/%=~_()|]*)?)/g,\n            function(text, m1, m2) {\n                const parts = m2.match(/^(.*)(&[a-z]+;|\\))$/);\n\n                let extra = '';\n                let url = m2;\n\n                if (parts !== null) {\n                    /* We caught an entity. Set it free. */\n                    url = parts[1];\n                    extra = parts[2];\n                }\n\n                const href = SITE_ROOT + url + (url.substr(-1) === '/' ? '' : '/');\n\n                return `${m1}<a target=\"_blank\" href=\"${href}\" class=\"review-request-link\">/${url}</a>${extra}`;\n            });\n    },\n\n    /**\n     * Linkify bug numbers.\n     *\n     * This will turn things that look like references to bugs (such as\n     * \"bug 408\") into clickable links.\n     *\n     * Args:\n     *     text (string):\n     *         The text to linkify.\n     *\n     *     bugTrackerURL (string):\n     *         The URL to use when formatting the bug number. This is expected\n     *         to have the literal ``--bug_id--`` in it, which will be replaced\n     *         by the captured bug ID.\n     *\n     * Returns:\n     *     string:\n     *     The given text with all bug references replaced by <a> tags.\n     */\n    linkifyBugs(text, bugTrackerURL) {\n        if (bugTrackerURL) {\n            return text.replace(\n                /\\b(bug|issue) (#([^.,)\\]\\s]+)|#?(\\d+))/gi,\n                function(text, m2, m3, bugnum1, bugnum2) {\n                    /*\n                     * The bug number can appear in either of those groups,\n                     * depending on how this was typed, so try both.\n                     */\n                    const bugnum = bugnum1 || bugnum2;\n                    const href = bugTrackerURL.replace(\"--bug_id--\", bugnum);\n\n                    return `<a target=\"_blank\" href=\"${href}\">${text}</a>`;\n                });\n        } else {\n            return text;\n        }\n    },\n\n    /**\n     * Linkify text using all available methods.\n     *\n     * Linkifies a block of text, turning URLs, /r/#/ paths, and bug numbers\n     * into clickable links.\n     *\n     * Args:\n     *     text (string):\n     *         The text to linkify.\n     *\n     *     bugTrackerURL (string):\n     *         The URL to use when formatting the bug number. This is expected\n     *         to have the literal ``--bug_id--`` in it, which will be replaced\n     *         by the captured bug ID.\n     *\n     *     isHTMLEncoded (boolean):\n     *         Whether or not the given text has already had dangerous\n     *         characters (like < or >) replaced by their HTML entities. If\n     *         this is false, the text will first be encoded.\n     *\n     * Returns:\n     *     string:\n     *     The given text with all linkifyable items replaced by <a> tags.\n     */\n    linkifyText(text, bugTrackerURL, isHTMLEncoded) {\n        if (!isHTMLEncoded) {\n            text = text.htmlEncode();\n        }\n\n        text = RB.LinkifyUtils.linkifyURLs(text);\n        text = RB.LinkifyUtils.linkifyReviewRequests(text);\n        text = RB.LinkifyUtils.linkifyBugs(text, bugTrackerURL);\n        return text;\n    },\n\n    /**\n     * Linkify text within a pre-established DOM tree.\n     *\n     * This iterates through a tree of nodes, linkifying any text nodes that\n     * reference bug URLs, review requests, or contain unlinked plain-text\n     * URLs.\n     *\n     * This will avoid linking anything within a <pre> tag, to avoid messing\n     * with code blocks, and <a> tags, to avoid linkifying existing links.\n     *\n     * Args:\n     *     el (Element):\n     *         The element to linkify.\n     *\n     *     bugTrackerURL (string):\n     *         The URL to use when formatting the bug number. This is expected\n     *         to have the literal ``--bug_id--`` in it, which will be replaced\n     *         by the captured bug ID.\n     */\n    linkifyChildren(el, bugTrackerURL) {\n        for (let i = 0; i < el.childNodes.length; i++) {\n            const node = el.childNodes[i];\n\n            if (node.nodeType === node.TEXT_NODE) {\n                if (node.textContent) {\n                    const newText = RB.LinkifyUtils.linkifyText(\n                        node.textContent, bugTrackerURL);\n\n                    if (newText !== node.textContent) {\n                        $(node).replaceWith(newText);\n                    }\n                }\n            } else if (node.nodeType === node.ELEMENT_NODE) {\n                if (node.nodeName !== 'PRE' && node.nodeName !== 'A') {\n                    RB.LinkifyUtils.linkifyChildren(node, bugTrackerURL);\n                }\n            }\n        }\n    }\n};\n"],"mappings":"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"}