{"version":3,"file":"fileAttachmentThumbnailView.js","names":["RB","FileAttachmentThumbnail","Backbone","View","extend","className","events","template","_","actionsTemplate","join","thumbnailContainerTemplate","initialize","options","_draftComment","_comments","_commentsProcessed","_scrollingThumbnail","_playingVideo","render","renderThumbnail","_renderContents","_$captionContainer","$","_$caption","find","listenTo","model","$el","fadeOut","remove","_onCaptionChanged","hover","_onHoverIn","bind","_onHoverOut","_$actionsContainer","_$actions","children","_$thumbnailContainer","_$file","bindProperty","elementToModel","_onLoadedChanged","_renderThumbnail","canEdit","_captionEditorView","InlineEditorView","el","editIconClass","showButtons","addClass","_stopAnimating","hasClass","$field","val","trigger","removeClass","value","ready","set","save","attrs","fadeIn","css","fadeTo","showCommentDlg","console","assert","get","_processComments","_createDraftComment","CommentDialogView","create","comment","publishedComments","publishedCommentsType","position","beside","side","fitOnScreen","comments","forEach","localdraft","comment_id","text","push","commentID","review","reviewRequest","createReview","createFileAttachmentComment","id","caption","captionText","captionClass","html","defaults","attributes","Djblets","enableRetinaImages","each","i","tabIndex","deleteText","downloadText","reviewText","commentText","updateText","_onAddCommentClicked","e","preventDefault","stopPropagation","_onUpdateClicked","updateDlg","UploadAttachmentView","attachmentHistoryID","target","data","presetCaption","reviewRequestEditor","show","_onDeleteClicked","destroy","$thumbnail","actionsWidth","outerWidth","actionsRight","offset","left","window","width","length","thumbnailEl","tagName","promise","play","undefined","then","catch","error","elHeight","height","thumbnailHeight","distance","duration","Math","abs","delay","animate","easing","complete","stop","pause"],"sources":["../../../../../static/rb/js/views/fileAttachmentThumbnailView.es6.js"],"sourcesContent":["/**\n * Displays a thumbnail depicting a file attachment.\n *\n * There are two ways that Review Board currently renders file attachments.\n * One is on page load (as part of the initial page template), and the other\n * is dynamically (when uploading vs Drag and Drop or manual upload).\n *\n * Depending on the method, we either already have elements to work with,\n * or we don't. In the latter case, it's currently up to the caller to\n * tell us, using the renderThumbnail option.\n *\n * File attachments that aren't already on the page that are currently loading\n * will be displayed as a blank file attachment (no identifying information)\n * with a spinner. When loaded, it will appear as a standard file attachment.\n *\n * The following signals are provided, on top of the standard Backbone.View\n * signals:\n *\n *     * beginEdit\n *       - Editing of the file attachment (caption) has begun.\n *\n *     * endEdit\n *       - Editing of the file attachment (caption) has finished.\n *\n *     * commentSaved\n *       - A draft comment on the file has been saved.\n *         (Only for file attachments without a Review UI.)\n */\nRB.FileAttachmentThumbnail = Backbone.View.extend({\n    className: 'file-container',\n\n    events: {\n        'click .file-delete': '_onDeleteClicked',\n        'click .file-add-comment a': '_onAddCommentClicked',\n        'click .file-update a': '_onUpdateClicked',\n    },\n\n    template: _.template(dedent`\n        <div class=\"file\">\n         <div class=\"file-actions-container\">\n          <ul class=\"file-actions\"></ul>\n         </div>\n         <div class=\"file-thumbnail-container\"></div>\n         <div class=\"file-caption-container\">\n          <div class=\"file-caption can-edit\"><a href=\"<%- downloadURL %>\" class=\"<%- captionClass %>\"><%- caption %></a></div>\n         </div>\n        </div>\n        `),\n\n    actionsTemplate: _.template([\n        '<% if (loaded) { %>',\n        '<%  if (reviewURL) { %>',\n        '<li><a class=\"file-review\" href=\"<%- reviewURL %>\">',\n        '<span class=\"fa fa-comment-o\"></span> <%- reviewText %></a>',\n        '</li>',\n        '<%  } else { %>',\n        '<li class=\"file-add-comment\">',\n        '<a href=\"#\"><span class=\"fa fa-comment-o\"></span> <%- commentText %></a>',\n        '</li>',\n        '<%  } %>',\n        '<li><a class=\"file-download\" href=\"<%- downloadURL %>\">',\n        '<span class=\"fa fa-download\"></span> <%- downloadText %>',\n        '</a></li>',\n        '<%  if (canEdit) { %>',\n        '<%   if (attachmentHistoryID) { %>',\n        '<li class=\"file-update\">',\n        '<a href=\"#\" data-attachment-history-id=\"<%- attachmentHistoryID %>\">',\n        '<span class=\"fa fa-upload\"></span> <%- updateText %>',\n        '</a></li>',\n        '<%   } %>',\n        '<li class=\"file-delete\"><a href=\"#\">',\n        '<span class=\"fa fa-trash-o\"></span> <%- deleteText %>',\n        '</a></li>',\n        '<%  } %>',\n        '<% } %>',\n    ].join('')),\n\n    thumbnailContainerTemplate: _.template([\n        '<% if (!loaded) { %>',\n        '<span class=\"fa fa-spinner fa-pulse\"></span>',\n        '<% } else { %>',\n        '<%     if (reviewURL) { %>',\n        '<a href=\"<%- reviewURL %>\" class=\"file-thumbnail-overlay\"></a>',\n        '<%     } %>',\n        '<%=  thumbnailHTML %>',\n        '<% } %>',\n    ].join('')),\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     canEdit (boolean):\n     *         Whether the user has permission to edit the file attachment.\n     *\n     *     comments (Array):\n     *         The comments on the file attachment.\n     *\n     *     renderThumbnail (boolean):\n     *         Whether the thumbnail should be rendered. This exists because we\n     *         sometimes attach to existing DOM elements rather than rendering\n     *         from scratch.\n     *\n     *     reviewRequest (RB.ReviewRequest):\n     *         The review request model.\n     *\n     *     reviewRequestEditor (RB.ReviewRequestEditor):\n     *         The review request editor.\n     */\n    initialize(options) {\n        this.options = options;\n\n        this._draftComment = null;\n        this._comments = [];\n        this._commentsProcessed = false;\n        this._scrollingThumbnail = false;\n        this._playingVideo = false;\n    },\n\n    /**\n     * Render the file attachment, and hooks up all events.\n     *\n     * If the renderThumbnail option was provided when constructing the view,\n     * this will render the thumbnail from scratch, and then dynamically\n     * update it as it loads. It will start off displaying with a spinner,\n     * if not yet loaded.\n     *\n     * In either case, this will set up the caption editor and other signals\n     * to control the lifetime of the thumbnail.\n     *\n     * Returns:\n     *     RB.FileAttachmentThumbnail:\n     *     This object, for chaining.\n     */\n    render() {\n        /*\n         * Until FileAttachmentThumbnail is the only thing rendering thumbnails,\n         * we'll be in a situation where we may either be working with an\n         * existing DOM element (for existing file attachments), or a new one\n         * (for newly uploaded file attachments). In the latter case, we'll want\n         * to render our own thumbnail.\n         */\n        if (this.options.renderThumbnail) {\n            this._renderContents();\n        }\n\n        this._$captionContainer = this.$('.file-caption');\n        this._$caption = this._$captionContainer.find('a.edit');\n\n        this.listenTo(this.model, 'destroy', () => {\n            this.$el.fadeOut(() => this.remove());\n        });\n\n        this.listenTo(this.model, 'change:caption', this._onCaptionChanged);\n        this._onCaptionChanged();\n\n        this.$el.hover(this._onHoverIn.bind(this),\n                       this._onHoverOut.bind(this));\n\n        if (this.options.renderThumbnail) {\n            this._$actionsContainer = this.$('.file-actions-container');\n            this._$actions = this._$actionsContainer.children('.file-actions');\n            this._$captionContainer = this.$('.file-caption-container');\n            this._$thumbnailContainer = this.$('.file-thumbnail-container');\n            this._$file = this.$('.file');\n\n            this._$actions.find('.file-download')\n                .bindProperty('href', this.model, 'downloadURL', {\n                    elementToModel: false,\n                });\n\n            this._$caption.bindProperty('href', this.model, 'downloadURL', {\n                elementToModel: false,\n            });\n\n            this.listenTo(this.model, 'change:loaded', this._onLoadedChanged);\n            this._onLoadedChanged();\n\n            this.listenTo(this.model, 'change:thumbnailHTML',\n                          this._renderThumbnail);\n            this._renderThumbnail();\n        }\n\n        if (this.options.canEdit !== false) {\n            this._captionEditorView = new RB.InlineEditorView({\n                el: this._$caption,\n                editIconClass: 'rb-icon rb-icon-edit',\n                showButtons: true,\n            });\n            this._captionEditorView.render();\n\n            this.listenTo(this._captionEditorView, 'beginEditPreShow', () => {\n                this.$el.addClass('editing');\n                this._stopAnimating();\n            });\n\n            this.listenTo(this._captionEditorView, 'beginEdit', () => {\n                if (this._$caption.hasClass('empty-caption')) {\n                    this._captionEditorView.$field.val('');\n                }\n\n                this.trigger('beginEdit');\n            });\n\n            this.listenTo(this._captionEditorView, 'cancel', () => {\n                this.$el.removeClass('editing');\n                this.trigger('endEdit');\n            });\n\n            this.listenTo(this._captionEditorView, 'complete', async (value) => {\n                this.$el.removeClass('editing');\n\n                /*\n                 * We want to set the caption after ready() finishes, in case\n                 * it loads state and overwrites.\n                 */\n                await this.model.ready();\n\n                this.model.set('caption', value);\n                this.trigger('endEdit');\n                await this.model.save({\n                    attrs: ['caption'],\n                });\n            });\n        }\n\n        return this;\n    },\n\n    /**\n     * Fade the view in.\n     */\n    fadeIn() {\n        this.$el\n            .css('opacity', 0)\n            .fadeTo(1000, 1);\n    },\n\n    /**\n     * Show the comment dialog for the file attachment.\n     *\n     * This is only ever used if the file attachment does not have a\n     * Review UI for it. A single comment dialog will appear, allowing\n     * comments on the file as a whole.\n     */\n    showCommentDlg() {\n        console.assert(!this.model.get('reviewURL'),\n                       'showCommentDlg can only be called if the file ' +\n                       'attachment does not have a review UI');\n        this._processComments();\n        this._createDraftComment();\n\n        RB.CommentDialogView.create({\n            comment: this._draftComment,\n            publishedComments: this._comments,\n            publishedCommentsType: 'file_attachment_comments',\n            position: {\n                beside: {\n                    el: this.$el,\n                    side: 'br',\n                    fitOnScreen: true,\n                },\n            },\n        });\n    },\n\n    /**\n     * Process all comments provided when constructing the view.\n     *\n     * The comments will be made usable by the comment dialog.\n     *\n     * This is only used if the file attachment does not have a Review UI.\n     */\n    _processComments() {\n        if (this._commentsProcessed) {\n            return;\n        }\n\n        const comments = this.options.comments || [];\n\n        comments.forEach(comment => {\n            if (comment.localdraft) {\n                this._createDraftComment(comment.comment_id, comment.text);\n            } else {\n                this._comments.push(comment);\n            }\n        });\n\n        this._commentsProcessed = true;\n    },\n\n    /**\n     * Create a new draft comment with the given ID and text.\n     *\n     * Only one draft comment can be created at a time.\n     *\n     * This is only used if the file attachment does not have a Review UI.\n     *\n     * Args:\n     *     commentID (number):\n     *         The ID of the draft comment.\n     *\n     *     text (string):\n     *         The comment text.\n     */\n    _createDraftComment(commentID, text) {\n        if (this._draftComment !== null) {\n            return;\n        }\n\n        const review = this.options.reviewRequest.createReview();\n        this._draftComment = review.createFileAttachmentComment(commentID,\n                                                                this.model.id);\n\n        if (text) {\n            this._draftComment.set('text', text);\n        }\n\n        this.listenTo(this._draftComment, 'saved',\n                      () => this.trigger('commentSaved', this._draftComment));\n    },\n\n    /**\n     * Render the contents of this view's element.\n     *\n     * This is only done when requested by the caller.\n     */\n    _renderContents() {\n        const caption = this.model.get('caption');\n        const captionText = caption ? caption : gettext('No caption');\n        const captionClass = caption ? 'edit' : 'edit empty-caption';\n\n        this.$el\n            .html(this.template(_.defaults({\n                caption: captionText,\n                captionClass: captionClass,\n            }, this.model.attributes)))\n            .addClass(this.className);\n    },\n\n    /**\n     * Render the thumbnail for the file attachment.\n     */\n    _renderThumbnail() {\n        this._$thumbnailContainer.html(\n            this.thumbnailContainerTemplate(this.model.attributes));\n\n        Djblets.enableRetinaImages(this._$thumbnailContainer);\n\n        // Disable tabbing to any <a> elements inside the thumbnail.\n        this._$thumbnailContainer.find('a').each((i, el) => {\n            el.tabIndex = -1;\n        });\n    },\n\n    /**\n     * Handler for when the model's 'loaded' property changes.\n     *\n     * Depending on if the file attachment is now loaded, either a\n     * blank spinner thumbnail will be shown, or a full thumbnail.\n     */\n    _onLoadedChanged() {\n        this._$actions.html(this.actionsTemplate(_.defaults({\n            canEdit: this.options.canEdit,\n            deleteText: gettext('Delete'),\n            downloadText: gettext('Download'),\n            reviewText: gettext('Review'),\n            commentText: gettext('Comment'),\n            updateText: gettext('Update'),\n        }, this.model.attributes)));\n    },\n\n    /**\n     * Handler for when the model's caption changes.\n     *\n     * If a caption is set, the thumbnail will display it. Otherwise,\n     * it will display \"No caption\".\n     */\n    _onCaptionChanged() {\n        const caption = this.model.get('caption');\n\n        if (caption) {\n            this._$caption\n                .text(caption)\n                .removeClass('empty-caption');\n        } else {\n            this._$caption\n                .text(gettext('No caption'))\n                .addClass('empty-caption');\n        }\n    },\n\n    /**\n     * Handler for the New Comment button.\n     *\n     * Shows the comment dialog.\n     *\n     * Args:\n     *     e (Event):\n     *         The event that triggered the action.\n     */\n    _onAddCommentClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.showCommentDlg();\n    },\n\n    /**\n     * Handler for the Update button.\n     *\n     * Shows the upload form.\n     *\n     * Args:\n     *     e (Event):\n     *         The event that triggered the action.\n     */\n    _onUpdateClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const updateDlg = new RB.UploadAttachmentView({\n            attachmentHistoryID: $(e.target).data('attachment-history-id'),\n            presetCaption: this.model.get('caption'),\n            reviewRequestEditor: this.options.reviewRequestEditor,\n        });\n        updateDlg.show();\n    },\n\n    /**\n     * Handler for the Delete button.\n     *\n     * Deletes the file attachment from the review request draft.\n     *\n     * Args:\n     *     e (Event):\n     *         The event that triggered the action.\n     */\n    _onDeleteClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.model.destroy();\n    },\n\n    /**\n     * Handler for when the mouse hovers over the thumbnail.\n     *\n     * Determines if we should scroll the thumbnail or not.\n     */\n    _onHoverIn() {\n        const $thumbnail = this.$('.file-thumbnail').children();\n        const actionsWidth = this._$actionsContainer.outerWidth();\n        const actionsRight = (this._$file.offset().left +\n                              this._$file.outerWidth() +\n                              actionsWidth);\n\n        this.trigger('hoverIn', this.$el);\n\n        /*\n         * Position the actions menu to the left or right of the attachment\n         * thumbnail.\n         */\n        if (actionsRight > $(window).width()) {\n            this._$actionsContainer\n                .css('left', -actionsWidth)\n                .addClass('left');\n        } else {\n            this._$actionsContainer\n                .css('left', '100%')\n                .addClass('right');\n        }\n\n        if (!this.$el.hasClass('editing') && $thumbnail.length === 1) {\n            const thumbnailEl = $thumbnail[0];\n\n            if (thumbnailEl.tagName === 'VIDEO') {\n                /* The thumbnail contains a video, so let's start playing it. */\n                const promise = thumbnailEl.play();\n\n                if (promise === undefined) {\n                    /* Older browsers don't return Promises. */\n                    this._playingVideo = true;\n                } else {\n                    promise\n                        .then(() => {\n                            this._playingVideo = true;\n                        })\n                        .catch(error => {\n                            /* Ignore the error. We just won't play it. */\n                            console.error(\n                                'Unable to play the video attachment: %s',\n                                error);\n                        });\n                }\n            } else {\n                /* Scroll the container to show all available content. */\n                const elHeight = this.$el.height();\n                const thumbnailHeight = $thumbnail.height() || 0;\n\n                if (thumbnailHeight > elHeight) {\n                    const distance = elHeight - thumbnailHeight;\n                    const duration =\n                        (Math.abs(distance) / 200) * 1000; // 200 pixels/s\n\n                    this._scrollingThumbnail = true;\n                    $thumbnail\n                        .delay(1000)\n                        .animate(\n                            { 'margin-top': distance + 'px' },\n                            {\n                                duration: duration,\n                                easing: 'linear',\n                            })\n                        .delay(500)\n                        .animate(\n                            { 'margin-top': 0 },\n                            {\n                                duration: duration,\n                                easing: 'linear',\n                                complete: () => {\n                                    this._scrollingThumbnail = false;\n                                },\n                            });\n                }\n            }\n        }\n    },\n\n    /**\n     * Handler for when the mouse stops hovering over the thumbnail.\n     *\n     * Removes the classes for the actions container, and stops animating\n     * the thumbnail contents.\n     */\n    _onHoverOut() {\n        this.trigger('hoverOut');\n\n        this._$actionsContainer\n            .removeClass('left')\n            .removeClass('right');\n\n        this._stopAnimating();\n    },\n\n    /**\n     * Stop animating this thumbnail.\n     *\n     * This is when moving the mouse outside of the thumbnail, or when the\n     * caption editor is opened.\n     */\n    _stopAnimating() {\n        if (this._scrollingThumbnail) {\n            this._scrollingThumbnail = false;\n            this.$('.file-thumbnail').children()\n                .stop(true)\n                .animate(\n                    { 'margin-top': 0 },\n                    { duration: 100 });\n        } else if (this._playingVideo) {\n            this._playingVideo = false;\n            this.$('video')[0].pause();\n        }\n    },\n});\n"],"mappings":"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"}