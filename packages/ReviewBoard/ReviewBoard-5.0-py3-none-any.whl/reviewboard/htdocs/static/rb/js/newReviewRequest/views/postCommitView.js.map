{"version":3,"file":"postCommitView.js","names":["RB","PostCommitView","Backbone","View","extend","className","loadErrorTemplate","_","template","events","initialize","options","model","repository","get","branches","_$scrollContainer","$scrollContainer","_$error","_branchesView","BranchesView","collection","on","branch","set","listenTo","_onBranchChanged","loaded","_loadBranches","render","_rendered","$","addClass","append","text","el","appendTo","$el","_commitsView","_onReloadBranchesClicked","_onReloadCommitsClicked","_loadCommits","_clearLoadError","fetch","err","hide","_showLoadError","message","show","_commitsCollection","checkFetchNext","remove","reloadID","errorLoadingText","temporaryFailureText","tryAgainText","errorLines","split","stopListening","getCommits","id","start","_onCreateReviewRequest","CommitsView","xhr","commit","_createPending","setPending","reviewRequest","ReviewRequest","localSitePrefix","createFromCommit","alert","_navigateTo","url","window","location"],"sources":["../../../../../../static/rb/js/newReviewRequest/views/postCommitView.es6.js"],"sourcesContent":["/**\n * A view orchestrating post-commit review request creation.\n *\n * This brings together the BranchesView and CommitsView to provide a UI for\n * letting people browse through the committed revisions in the repository. When\n * the user clicks on one of the commits, it will create a new review request\n * using that commit's ID.\n */\nRB.PostCommitView = Backbone.View.extend({\n    className: 'post-commit',\n\n    loadErrorTemplate: _.template(dedent`\n        <div class=\"error\">\n         <p><%- errorLoadingText %></p>\n         <p class=\"error-text\">\n          <% _.each(errorLines, function(line) { %><%- line %><br /><% }); %>\n         </p>\n         <p>\n          <%- temporaryFailureText %>\n          <a href=\"#\" id=\"reload_<%- reloadID %>\"><%- tryAgainText %></a>\n         </p>\n        </div>\n    `),\n\n    events: {\n        'click #reload_branches': '_onReloadBranchesClicked',\n        'click #reload_commits': '_onReloadCommitsClicked',\n    },\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     $scrollContainer (jQuery):\n     *         The parent container handling all content scrolling.\n     */\n    initialize(options) {\n        const model = this.model;\n        const repository = model.get('repository');\n        const branches = repository.branches;\n\n        this._$scrollContainer = options.$scrollContainer;\n        this._$error = null;\n\n        // Set up the branch selector and bind it to the \"branch\" attribute\n        this._branchesView = new RB.BranchesView({\n            collection: branches,\n        });\n        this._branchesView.on('selected',\n                              branch => model.set('branch', branch));\n\n        this.listenTo(model, 'change:branch', this._onBranchChanged);\n\n        if (!branches.loaded) {\n            this._loadBranches();\n        }\n    },\n\n    /**\n     * Render the view.\n     *\n     * Returns:\n     *     RB.PostCommitView:\n     *     This object, for chaining.\n     */\n    render() {\n        this._rendered = true;\n\n        $('<div/>')\n            .addClass('branches section-header')\n            .append($('<span/>')\n                .text(gettext('Create from an existing commit on:')))\n            .append(this._branchesView.render().el)\n            .appendTo(this.$el);\n\n        if (this._commitsView) {\n            this.$el.append(this._commitsView.render().el);\n        }\n\n        return this;\n    },\n\n    /**\n     * Callback for when the user clicked on the reload branches button.\n     *\n     * This exists for use with unit test spies.\n     */\n    _onReloadBranchesClicked() {\n        this._loadBranches();\n    },\n\n    /**\n     * Callback for when the user clicked on the reload commits button.\n     *\n     * This exists for use with unit test spies.\n     */\n    _onReloadCommitsClicked() {\n        this._loadCommits();\n    },\n\n    /**\n     * Load the list of branches from the repository.\n     *\n     * If there's an error loading the branches, the branches selector and\n     * commits list will be hidden, and an error will be displayed along\n     * with the message from the server. The user will have the ability to\n     * try again.\n     *\n     * Version Changed:\n     *     5.0:\n     *     The promise return value was added.\n     *\n     * Returns:\n     *     Promise:\n     *     A promise which resolves when the operation is complete.\n     */\n    async _loadBranches() {\n        this._clearLoadError();\n\n        const branches = this.model.get('repository').branches;\n\n        try {\n            await branches.fetch();\n        } catch (err) {\n            this._branchesView.$el.hide();\n            this._commitsView?.$el?.hide();\n            this._showLoadError('branches', err.message);\n            return;\n        }\n\n        branches.loaded = true;\n        this._branchesView.$el.show();\n        this._commitsView?.$el?.hide();\n    },\n\n    /**\n     * Load the list of commits from the repository.\n     *\n     * If there's an error loading the commits, the commits list will be\n     * hidden, and an error will be displayed along with the message from\n     * the server. The user will have the ability to try again.\n     *\n     * Version Changed:\n     *     5.0:\n     *     The promise return value was added.\n     *\n     * Returns:\n     *     Promise:\n     *     A promise which resolves when the operation is complete.\n     */\n    async _loadCommits() {\n        this._clearLoadError();\n\n        try {\n            await this._commitsCollection.fetch();\n        } catch(err) {\n            this._commitsView.$el.hide();\n            this._showLoadError('commits', err.message);\n            return;\n        }\n\n        this._commitsView.$el.show();\n        this._commitsView.checkFetchNext();\n    },\n\n    /**\n     * Clear any displayed error message.\n     */\n    _clearLoadError() {\n        if (this._$error) {\n            this._$error.remove();\n            this._$error = null;\n        }\n    },\n\n    /**\n     * Show an error message indicating a load failure.\n     *\n     * The message from the server will be displayed along with some\n     * helpful text and a link for trying the request again.\n     *\n     * Args:\n     *     reloadID (string):\n     *         An ID to use for the reload link element.\n     *\n     *     err (string):\n     *         The error text.\n     */\n    _showLoadError(reloadID, err) {\n        this._clearLoadError();\n\n        this._$error = $(this.loadErrorTemplate({\n                errorLoadingText: gettext('There was an error loading information from this repository:'),\n                temporaryFailureText: gettext('This may be a temporary failure.'),\n                tryAgainText: gettext('Try again'),\n                errorLines: err.split('\\n'),\n                reloadID: reloadID,\n            }))\n            .appendTo(this.$el);\n    },\n\n    /**\n     * Callback for when the user chooses a different branch.\n     *\n     * Fetches a new list of commits starting from the tip of the selected\n     * branch.\n     *\n     * Args:\n     *     model (RB.PostCommitModel):\n     *         The data model.\n     *\n     *     branch (RB.RepositoryBranch):\n     *         The selected branch.\n     */\n    _onBranchChanged(model, branch) {\n        if (this._commitsView) {\n            this.stopListening(this._commitsCollection);\n            this._commitsView.remove();\n        }\n\n        this._commitsCollection =\n            this.model.get('repository').getCommits({\n                branch: branch.id,\n                start: branch.get('commit'),\n            });\n        this.listenTo(this._commitsCollection, 'create',\n                      this._onCreateReviewRequest);\n\n        this._commitsView = new RB.CommitsView({\n            collection: this._commitsCollection,\n            $scrollContainer: this._$scrollContainer,\n        });\n        this.listenTo(this._commitsView, 'loadError', xhr => {\n            this._showLoadError('commits', xhr);\n        });\n\n        if (this._rendered) {\n            this.$el.append(this._commitsView.render().el);\n        }\n\n        this._loadCommits();\n    },\n\n    /**\n     * Callback for when a commit is selected.\n     *\n     * Creates a new review request with the given commit ID and redirects the\n     * browser to it.\n     *\n     * Args:\n     *     commit (RB.RepositoryCommit):\n     *         The selected commit.\n     */\n    async _onCreateReviewRequest(commit) {\n        if (this._createPending) {\n            // Do nothing\n            return;\n        }\n\n        this._createPending = true;\n        this._commitsView.setPending(commit);\n\n        const repository = this.model.get('repository');\n        const reviewRequest = new RB.ReviewRequest({\n            repository: repository.id,\n            localSitePrefix: repository.get('localSitePrefix')\n        });\n\n        try {\n            await reviewRequest.createFromCommit(commit.id);\n        } catch (err) {\n            this._commitsView.setPending(null);\n            this._createPending = false;\n            alert(err.message);\n            return;\n        }\n\n        this._navigateTo(reviewRequest.get('reviewURL'));\n    },\n\n    /**\n     * Navigate to the given URL.\n     *\n     * This exists so it can be overridden by unit tests.\n     *\n     * Args:\n     *     url (string):\n     *         The URL to navigate to.\n     */\n    _navigateTo(url) {\n        window.location = url;\n    },\n});\n"],"mappings":"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"}