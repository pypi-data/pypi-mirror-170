{"version":3,"file":"addIntegrationPopupView.js","names":["Djblets","AddIntegrationPopupView","Backbone","View","extend","className","integrationTemplateSource","emptyIntegrationsTemplateSource","_","escape","initialize","options","integrations","render","length","itemTemplate","template","$list","$","i","append","$el","addClass","remove","hide","prototype","call","show","$button","$window","window","el","buttonPos","position","move","left","top","outerHeight","width","height","popupBorderWidths","getExtents","scrollbarWidth","offsetWidth","clientWidth","popupOffset","offset","popupHeight","Math","floor","css","hasClass","tileWidth","find","filter","outerWidth","winWidth","availWidth","popupWidth","max","newScrollbarWidth","document","one","off"],"sources":["../../../../../../static/djblets/js/integrations/views/addIntegrationPopupView.es6.js"],"sourcesContent":["/**\n * A popup for selecting an integration to add.\n */\nDjblets.AddIntegrationPopupView = Backbone.View.extend({\n    className: 'djblets-c-integrations-popup',\n\n    /**\n     * The pre-compiled template for an integration in the popup.\n     *\n     * This will be compiled when the popup is first being built, if\n     * integrations are available.\n     */\n    integrationTemplateSource: dedent`\n        <li class=\"djblets-c-integration\">\n         <a href=\"<%- addURL %>\">\n          <% if (iconSrc) { %>\n           <img class=\"djblets-c-integration__icon\"\n                src=\"<%- iconSrc %>\"\n                srcset=\"<%- iconSrcSet %>\"\n                width=\"48\" height=\"48\" alt=\"\">\n          <% } %>\n          <div class=\"djblets-c-integration__details\">\n           <div class=\"djblets-c-integration__name\"><%- name %></div>\n           <div class=\"djblets-c-integration__description\">\n            <%- description %>\n           </div>\n          </div>\n         </a>\n        </li>\n    `,\n\n    /**\n     * The pre-compiled template for the empty integrations popup content.\n     *\n     * This will be compiled when the popup is first being built, if\n     * integrations are not available.\n     */\n    emptyIntegrationsTemplateSource: dedent`\n        <p class=\"djblets-c-integrations-popup__empty\">\n         ${_.escape(_`There are no integrations currently installed.`)}\n        </p>\n    `,\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options passed to the view.\n     *\n     * Option Args:\n     *     integrations (Array):\n     *         An array of integration data to render.\n     */\n    initialize(options) {\n        this.integrations = options.integrations;\n    },\n\n    /**\n     * Render the list of integrations in the popup.\n     *\n     * If there are integrations to display, the\n     * :js:attr:`integrationTemplateSource` attribute will be used for each\n     * item.\n     *\n     * If there aren't any integrations to display, the\n     * :js:attr:`emptyIntegrationsTemplateSource` attribute will be used\n     * for the contents.\n     *\n     * Returns:\n     *     Djblets.AddIntegrationPopupView:\n     *     This object, for chaining.\n     */\n    render() {\n        const integrations = this.integrations;\n\n        if (integrations.length > 0) {\n            /* We have integrations to show. Add each to the list. */\n            const itemTemplate =\n                _.template(this.integrationTemplateSource);\n            const $list = $('<ul>');\n\n            for (let i = 0; i < integrations.length; i++) {\n                $list.append(itemTemplate(integrations[i]));\n            }\n\n            this.$el.append($list);\n        } else {\n            /*\n             * There are no integrations installed. Display an appropriate\n             * message.\n             */\n            this.$el\n                .addClass('-is-empty')\n                .append(_.template(this.emptyIntegrationsTemplateSource)());\n        }\n\n        return this;\n    },\n\n    /**\n     * Remove the view.\n     *\n     * This will first hide the popup, unregistering any events, and will\n     * then remove the element from the DOM.\n     */\n    remove() {\n        this.hide();\n\n        Backbone.View.prototype.remove.call(this);\n    },\n\n    /**\n     * Show the popup, anchored to a button.\n     *\n     * The popup will be displayed on the screen, presenting the list of\n     * rendered integrations. The top-left of the popup will be anchored to\n     * the bottom-left of the provided button.\n     *\n     * Events are hooked up to automatically dismiss the popup when clicking\n     * away from the popup or resizing the window.\n     *\n     * Args:\n     *     $button (jQuery):\n     *         The button element to anchor to.\n     */\n    show($button) {\n        const $window = $(window);\n        const $el = this.$el;\n        const el = this.el;\n        const buttonPos = $button.position();\n\n        /*\n         * First, position the popup and set it to a small size to trigger\n         * scrolling behavior, so we can perform calculations. It does need\n         * to be big enough to fit the scrollbar, though, hence the width.\n         */\n        $el\n            .move(buttonPos.left,\n                  buttonPos.top + $button.outerHeight(),\n                  'absolute')\n            .width(100)\n            .height(1)\n            .show();\n\n        const popupBorderWidths = $el.getExtents('b', 'lr');\n        const scrollbarWidth = el.offsetWidth - el.clientWidth -\n                               popupBorderWidths;\n\n        const popupOffset = $el.offset();\n        const popupHeight = Math.floor(\n            $window.height() - popupOffset.top -\n            $el.getExtents('bm', 'tb'));\n\n        /*\n         * Set the new width and height.\n         *\n         * We're resetting the height back to \"auto\" so it's not forced to be\n         * too big, but cap around the screen boundary so it can't grow too\n         * large.\n         */\n        $el.css({\n            'height': 'auto',\n            'max-height': popupHeight,\n        });\n\n        if ($el.hasClass('-is-empty')) {\n            $el.css('width', 'auto');\n        } else {\n            /*\n             * Get the width of one of the integration tiles in the popup, so\n             * we can start to figure out how many we can fit on screen.\n             */\n            const tileWidth = $el\n                .find('.djblets-c-integration')\n                .filter(':first')\n                .outerWidth(true);\n            const winWidth = $window.width();\n            const availWidth = winWidth - popupOffset.left - scrollbarWidth -\n                               $el.getExtents('m', 'r');\n\n            let popupWidth = Math.max(Math.floor(availWidth / tileWidth), 1) *\n                             tileWidth + scrollbarWidth + popupBorderWidths;\n\n            $el.outerWidth(popupWidth);\n\n            /*\n             * Now that we have a width and height set, we might not actually\n             * be showing a scrollbar anymore. Find out how much extra space we\n             * now have here, and if it's not what we had before for the scroll\n             * bar, we can strip that out.\n             */\n            const newScrollbarWidth = el.offsetWidth -\n                                      el.clientWidth -\n                                      popupBorderWidths;\n\n            if (newScrollbarWidth === 0) {\n                popupWidth -= scrollbarWidth;\n                $el.outerWidth(popupWidth);\n            }\n\n            /*\n             * If the menu is off-screen (which might be due to a very small\n             * screen width), we'll need to shift the popup over a bit.\n             */\n            if (popupOffset.left + popupWidth > winWidth) {\n                $el.css('left', winWidth - popupWidth);\n            }\n        }\n\n        /*\n         * Wire up events to hide the popup when the document is clicked or\n         * the window resized.\n         */\n        $(document).one('click.djblets-integrations-popup',\n                        () => this.hide());\n        $(window).one('resize.djblets-integrations-popup',\n                      () => this.hide());\n    },\n\n    /**\n     * Hide the popup.\n     *\n     * This will hide the popup from the screen and disconnect all related\n     * events.\n     */\n    hide() {\n        this.$el.hide();\n\n        $(document).off('click.djblets-integrations-popup');\n        $(window).off('resize.djblets-integrations-popup');\n    },\n});\n"],"mappings":"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"}