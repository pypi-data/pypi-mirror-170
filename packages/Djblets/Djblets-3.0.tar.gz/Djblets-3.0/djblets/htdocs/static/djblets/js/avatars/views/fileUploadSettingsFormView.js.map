{"version":3,"file":"fileUploadSettingsFormView.js","names":["allowedMimeTypes","ParentView","Djblets","Avatars","ServiceSettingsFormView","FileUploadSettingsFormView","extend","events","validate","file","_$fileInput","files","alert","some","el","type","render","_$box","$","_$preview","_onBrowseClicked","e","preventDefault","stopPropagation","click","_onDragEnter","target","width","addClass","_onDragOver","dt","originalEvent","dataTransfer","dropEffect","_onDragLeave","removeClass","_onDrop","length","fileType","exc","_setAvatarFromFile","_onFileChanged","reader","FileReader","addEventListener","empty","append","attr","src","result","alt","readAsDataURL"],"sources":["../../../../../../static/djblets/js/avatars/views/fileUploadSettingsFormView.es6.js"],"sourcesContent":["(function() {\n\n\nconst allowedMimeTypes = [\n    'image/png', 'image/jpeg', 'image/gif'\n];\n\n\nconst ParentView = Djblets.Avatars.ServiceSettingsFormView;\n\n\n/**\n * A file upload avatar settings form.\n *\n * This form provides a preview of the uploaded avatar.\n */\nDjblets.Avatars.FileUploadSettingsFormView = ParentView.extend({\n    events: {\n        'change #id_file-upload-avatar_upload': '_onFileChanged',\n        'click .avatar-file-upload-browse': '_onBrowseClicked',\n        'click .avatar-preview': '_onBrowseClicked',\n        'dragenter .avatar-file-upload-config': '_onDragEnter',\n        'dragover .avatar-file-upload-config': '_onDragOver',\n        'dragleave .avatar-file-upload-config': '_onDragLeave',\n        'drop .avatar-file-upload-config': '_onDrop',\n    },\n\n    /**\n     * Validate the form.\n     *\n     * If a file is selected, ensure it is has the correct MIME type.\n     */\n    validate() {\n        const file = this._$fileInput[0].files[0];\n\n        if (!file) {\n            alert(_`You must choose a file.`);\n            return false;\n        }\n\n        if (!allowedMimeTypes.some(el => (el === file.type))) {\n            alert(_`\n                This wasn't a valid image file format. Please provide a PNG,\n                JPEG, or GIF file.\n            `);\n            return false;\n        }\n\n        return true;\n    },\n\n    /**\n     * Render the form.\n     *\n     * Returns:\n     *     Djblets.Avatars.FileUploadSettingsFormView:\n     *     This view (for chaining).\n     */\n    render() {\n        this._$box = this.$('.avatar-file-upload-config');\n        this._$preview = this.$('.avatar-preview');\n        this._$fileInput = this.$('#id_file-upload-avatar_upload');\n\n        return this;\n    },\n\n    /**\n     * Handler for a click event on the \"browse\" instruction text.\n     *\n     * This will trigger opening the hidden file input.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The click event.\n     */\n    _onBrowseClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        /*\n         * Clicking on the file input itself is not reliable. There are ways\n         * to make it work, but the browser actively avoids letting you do it if\n         * it seems to be hidden. However, it works just fine universally to\n         * click on the label.\n         */\n        this.$('#avatar-file-upload-browse-label').click();\n    },\n\n    /**\n     * Handler for a drag enter event.\n     *\n     * If the configuration box is being hovered over, this will enable the\n     * hover state, giving users an indication that they can drop the image\n     * there.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag over event.\n     */\n    _onDragEnter(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            this._$box\n                .width(this._$box.width())\n                .addClass('drag-hover');\n        }\n    },\n\n    /**\n     * Handler for a drag over event.\n     *\n     * If the configuration box is being hovered over, this will set the drop\n     * effect.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag over event.\n     */\n    _onDragOver(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            const dt = e.originalEvent.dataTransfer;\n\n            if (dt) {\n                dt.dropEffect = 'copy';\n            }\n        }\n    },\n\n    /**\n     * Handler for a drag leave event.\n     *\n     * If the configuration box is being left, this will remove the hover state\n     * and reset the drop effect.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag leave event.\n     */\n    _onDragLeave(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            this._$box\n                .removeClass('drag-hover')\n                .width('auto');\n\n            const dt = e.originalEvent.dataTransfer;\n\n            if (dt) {\n                dt.dropEffect = 'none';\n            }\n        }\n    },\n\n    /**\n     * Handler for a drop operation.\n     *\n     * This will remove the hover state and attempt to set the list of files\n     * on the file input. If this fails (which will be the case on some browsers\n     * with older behavior), the user will receive an alert telling them it\n     * failed and to try browsing instead.\n     *\n     * If all goes well, the avatar will be ready for upload and the preview\n     * image will be updated.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drop event.\n     */\n    _onDrop(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._$box.removeClass('drag-hover');\n\n        const dt = e.originalEvent.dataTransfer;\n        const files = dt && dt.files;\n\n        if (!files || files.length === 0) {\n            return;\n        }\n\n        if (files.length > 1) {\n            alert(_`\n                You can only set one file as your avatar. Please drag and\n                drop a single file.\n            `);\n            return;\n        }\n\n        const fileType = files[0].type;\n\n        if (fileType !== 'image/png' && fileType !== 'image/jpeg' &&\n            fileType !== 'image/gif') {\n            alert(_`\n                This doesn't appear to be a compatible image file for avatars.\n                Please upload a PNG, JPEG, or GIF file.\n            `);\n            return;\n        }\n\n        try {\n            this._$fileInput[0].files = files;\n        } catch (exc) {\n            /*\n             * While most modern browsers allow setting the `files` property of\n             * an input field to the rest of a drag-and-drop operation, not all\n             * do (I'm looking at you, IE/Edge). Older browsers will also\n             * complain. So instead of outright failing, tell the user that this\n             * won't work and suggest a workaround.\n             */\n            alert(_`\n                Looks like dragging to upload a file isn't going to work with\n                your browser. Try browsing for a file instead.\n            `);\n            return;\n        }\n\n        this._setAvatarFromFile(files[0]);\n    },\n\n    /**\n     * Handler for when the file input has changed.\n     *\n     * This will update the preview image.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The change event.\n     */\n    _onFileChanged(e) {\n        const file = e.target.files[0];\n\n        if (file) {\n            this._setAvatarFromFile(file);\n        }\n    },\n\n    /**\n     * Set the avatar from the provided file upload.\n     *\n     * Args:\n     *     file (File):\n     *         The file that was uploaded.\n     */\n    _setAvatarFromFile(file) {\n        const reader = new FileReader();\n\n        reader.addEventListener('load', () => {\n            this._$preview\n                .empty()\n                .removeClass('avatar-preview-unset')\n                .append($('<img />').attr({\n                     src: reader.result,\n                     alt: _`Your new avatar`,\n                 }));\n        });\n\n        reader.readAsDataURL(file);\n    },\n});\n\n\n})();\n"],"mappings":";;AAAA,CAAC,YAAW;EAGZ,MAAMA,gBAAgB,GAAG,CACrB,WADqB,EACR,YADQ,EACM,WADN,CAAzB;EAKA,MAAMC,UAAU,GAAGC,OAAO,CAACC,OAAR,CAAgBC,uBAAnC;EAGA;AACA;AACA;AACA;AACA;;EACAF,OAAO,CAACC,OAAR,CAAgBE,0BAAhB,GAA6CJ,UAAU,CAACK,MAAX,CAAkB;IAC3DC,MAAM,EAAE;MACJ,wCAAwC,gBADpC;MAEJ,oCAAoC,kBAFhC;MAGJ,yBAAyB,kBAHrB;MAIJ,wCAAwC,cAJpC;MAKJ,uCAAuC,aALnC;MAMJ,wCAAwC,cANpC;MAOJ,mCAAmC;IAP/B,CADmD;;IAW3D;AACJ;AACA;AACA;AACA;IACIC,QAAQ,GAAG;MACP,MAAMC,IAAI,GAAG,KAAKC,WAAL,CAAiB,CAAjB,EAAoBC,KAApB,CAA0B,CAA1B,CAAb;;MAEA,IAAI,CAACF,IAAL,EAAW;QACPG,KAAK,oCAAL;QACA,OAAO,KAAP;MACH;;MAED,IAAI,CAACZ,gBAAgB,CAACa,IAAjB,CAAsBC,EAAE,IAAKA,EAAE,KAAKL,IAAI,CAACM,IAAzC,CAAL,EAAsD;QAClDH,KAAK,4FAAL;QAIA,OAAO,KAAP;MACH;;MAED,OAAO,IAAP;IACH,CAjC0D;;IAmC3D;AACJ;AACA;AACA;AACA;AACA;AACA;IACII,MAAM,GAAG;MACL,KAAKC,KAAL,GAAa,KAAKC,CAAL,CAAO,4BAAP,CAAb;MACA,KAAKC,SAAL,GAAiB,KAAKD,CAAL,CAAO,iBAAP,CAAjB;MACA,KAAKR,WAAL,GAAmB,KAAKQ,CAAL,CAAO,+BAAP,CAAnB;MAEA,OAAO,IAAP;IACH,CAhD0D;;IAkD3D;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIE,gBAAgB,CAACC,CAAD,EAAI;MAChBA,CAAC,CAACC,cAAF;MACAD,CAAC,CAACE,eAAF;MAEA;AACR;AACA;AACA;AACA;AACA;;MACQ,KAAKL,CAAL,CAAO,kCAAP,EAA2CM,KAA3C;IACH,CAtE0D;;IAwE3D;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIC,YAAY,CAACJ,CAAD,EAAI;MACZA,CAAC,CAACC,cAAF;MACAD,CAAC,CAACE,eAAF;;MAEA,IAAIF,CAAC,CAACK,MAAF,KAAa,KAAKT,KAAL,CAAW,CAAX,CAAjB,EAAgC;QAC5B,KAAKA,KAAL,CACKU,KADL,CACW,KAAKV,KAAL,CAAWU,KAAX,EADX,EAEKC,QAFL,CAEc,YAFd;MAGH;IACJ,CA5F0D;;IA8F3D;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIC,WAAW,CAACR,CAAD,EAAI;MACXA,CAAC,CAACC,cAAF;MACAD,CAAC,CAACE,eAAF;;MAEA,IAAIF,CAAC,CAACK,MAAF,KAAa,KAAKT,KAAL,CAAW,CAAX,CAAjB,EAAgC;QAC5B,MAAMa,EAAE,GAAGT,CAAC,CAACU,aAAF,CAAgBC,YAA3B;;QAEA,IAAIF,EAAJ,EAAQ;UACJA,EAAE,CAACG,UAAH,GAAgB,MAAhB;QACH;MACJ;IACJ,CAnH0D;;IAqH3D;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIC,YAAY,CAACb,CAAD,EAAI;MACZA,CAAC,CAACC,cAAF;MACAD,CAAC,CAACE,eAAF;;MAEA,IAAIF,CAAC,CAACK,MAAF,KAAa,KAAKT,KAAL,CAAW,CAAX,CAAjB,EAAgC;QAC5B,KAAKA,KAAL,CACKkB,WADL,CACiB,YADjB,EAEKR,KAFL,CAEW,MAFX;;QAIA,MAAMG,EAAE,GAAGT,CAAC,CAACU,aAAF,CAAgBC,YAA3B;;QAEA,IAAIF,EAAJ,EAAQ;UACJA,EAAE,CAACG,UAAH,GAAgB,MAAhB;QACH;MACJ;IACJ,CA9I0D;;IAgJ3D;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIG,OAAO,CAACf,CAAD,EAAI;MACPA,CAAC,CAACC,cAAF;MACAD,CAAC,CAACE,eAAF;;MAEA,KAAKN,KAAL,CAAWkB,WAAX,CAAuB,YAAvB;;MAEA,MAAML,EAAE,GAAGT,CAAC,CAACU,aAAF,CAAgBC,YAA3B;MACA,MAAMrB,KAAK,GAAGmB,EAAE,IAAIA,EAAE,CAACnB,KAAvB;;MAEA,IAAI,CAACA,KAAD,IAAUA,KAAK,CAAC0B,MAAN,KAAiB,CAA/B,EAAkC;QAC9B;MACH;;MAED,IAAI1B,KAAK,CAAC0B,MAAN,GAAe,CAAnB,EAAsB;QAClBzB,KAAK,0FAAL;QAIA;MACH;;MAED,MAAM0B,QAAQ,GAAG3B,KAAK,CAAC,CAAD,CAAL,CAASI,IAA1B;;MAEA,IAAIuB,QAAQ,KAAK,WAAb,IAA4BA,QAAQ,KAAK,YAAzC,IACAA,QAAQ,KAAK,WADjB,EAC8B;QAC1B1B,KAAK,mHAAL;QAIA;MACH;;MAED,IAAI;QACA,KAAKF,WAAL,CAAiB,CAAjB,EAAoBC,KAApB,GAA4BA,KAA5B;MACH,CAFD,CAEE,OAAO4B,GAAP,EAAY;QACV;AACZ;AACA;AACA;AACA;AACA;AACA;QACY3B,KAAK,yHAAL;QAIA;MACH;;MAED,KAAK4B,kBAAL,CAAwB7B,KAAK,CAAC,CAAD,CAA7B;IACH,CAjN0D;;IAmN3D;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACI8B,cAAc,CAACpB,CAAD,EAAI;MACd,MAAMZ,IAAI,GAAGY,CAAC,CAACK,MAAF,CAASf,KAAT,CAAe,CAAf,CAAb;;MAEA,IAAIF,IAAJ,EAAU;QACN,KAAK+B,kBAAL,CAAwB/B,IAAxB;MACH;IACJ,CAlO0D;;IAoO3D;AACJ;AACA;AACA;AACA;AACA;AACA;IACI+B,kBAAkB,CAAC/B,IAAD,EAAO;MACrB,MAAMiC,MAAM,GAAG,IAAIC,UAAJ,EAAf;MAEAD,MAAM,CAACE,gBAAP,CAAwB,MAAxB,EAAgC,MAAM;QAClC,KAAKzB,SAAL,CACK0B,KADL,GAEKV,WAFL,CAEiB,sBAFjB,EAGKW,MAHL,CAGY5B,CAAC,CAAC,SAAD,CAAD,CAAa6B,IAAb,CAAkB;UACrBC,GAAG,EAAEN,MAAM,CAACO,MADS;UAErBC,GAAG;QAFkB,CAAlB,CAHZ;MAOH,CARD;MAUAR,MAAM,CAACS,aAAP,CAAqB1C,IAArB;IACH;;EAzP0D,CAAlB,CAA7C;AA6PC,CA7QD"}