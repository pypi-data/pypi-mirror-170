---
- name: test setup for the libvirt hypervisor
  hosts: hypervisor-service-group
  become: false

  pre_tasks:

    - name: dotenough for test purposes
      copy:
        src: files/inventory
        dest: .enough/hypervisor.tld

    - name: enough --domain hypervisor.tld libvirt network
      shell: |
        enough --domain hypervisor.tld libvirt network

    #
    # Whenever libvirt creates networks, it messes up the docker
    # iptables configuration, restart docker to set them right again
    #
    - name: systemctl restart docker
      service:
        name: docker
        state: restarted
      become: true

    - name: enough --domain hypervisor.tld host create --driver=libvirt other-host
      shell: |
        enough --domain hypervisor.tld host create --driver=libvirt other-host
