{% extends 'series-set-layout.html' %}

{% from 'macros.html' import alerter, bootstrap_icon, info_popover, visualize_series %}

{% block styles %}
<style nonce="{{ csp_nonce }}">
    .series-table {
        table-layout: fixed;
    }
    .series-table .series-add {
        width: 10%;
    }
    .pattern-table {
        table-layout: fixed;
    }
    .table-check {
        width: 10%;
    }
</style>
{% endblock %}

{% block menu %}
{{ series_set_menu('Time series') }}
{% endblock %}

{% block custom_actions %}
{% if series_set.origin.value == 'ui' %}
<a class="btn btn-primary me-2 mb-2 mb-sm-0" data-bs-toggle="offcanvas" href="#seriesAddOffCanvas">
    Add series
</a>
{% endif %}
{% endblock %}

{% block series_set_content %}
<div class="offcanvas offcanvas-end {% if pattern or keep_offcanvas_open or validating_time_series %}show{% endif %}" tabindex="-1" id="seriesAddOffCanvas">
    <div class="offcanvas-header">
        <h3 class="offcanvas-title h5">Add time series</h3>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">

        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if not pattern and not validating_time_series %}active{% endif %}" id="seriesAddTabLabel" data-bs-toggle="tab" data-bs-target="#seriesAddPanel" type="button" role="tab" aria-controls="seriesAddPanel" aria-selected="true">
                    Series
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if pattern and not validating_time_series %}active{% endif %}" id="patternAddTabLabel" data-bs-toggle="tab" data-bs-target="#patternAddPanel" type="button" role="tab" aria-controls="patternAddPanel" aria-selected="false">
                    Pattern
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if validating_time_series %}active{% endif %}" id="bulkAddTabLabel" data-bs-toggle="tab" data-bs-target="#bulkAddPanel" type="button" role="tab" aria-controls="bulkAddPanel" aria-selected="false">
                    Bulk
                </button>
            </li>
        </ul>

        <div class="tab-content" id="seriesAddContent">
            <div class="tab-pane {% if not pattern and not validating_time_series %}show active{% endif %}" id="seriesAddPanel" role="tabpanel" aria-labelledby="seriesAddTabLabel">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="seriessetname" value="{{ series_set.name }}">

                    <div class="my-3">
                        <label for="sourcenameSelect" class="form-label">Select time series source</label>
                        <select class="form-select" id="sourcenameSelect" name="sourcename">
                            {% for source in sources %}
                            <option {% if source == source_name %}selected{% endif %}>{{ source }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="my-3">
                        <label for="seriesnameInput" class="form-label">Select time series</label>
                        <input type="text"
                               class="form-control"
                               id="seriesnameInput"
                               name="seriesname"
                               value=""
                               autocomplete="off"
                               placeholder="Type to search time series"
                               required>
                    </div>

                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="addanother" name="addanother" {% if keep_offcanvas_open %}checked{% endif %}>
                        <label for="addanother" class="form-check-label">Add another</label>
                    </div>

                    <div class="my-3">
                        <button type="submit" class="btn btn-primary">Add series</button>
                    </div>
                </form>
            </div>

            <div class="tab-pane {% if pattern and not validating_time_series %}show active{% endif %}" id="patternAddPanel" role="tabpanel" aria-labelledby="patternAddTabLabel">
                <form>
                    <input type="hidden" name="seriessetname" value="{{ series_set.name }}">

                    <div class="my-3">
                        <label for="patternSourcenameSelect" class="form-label">Select time series source</label>
                        <select class="form-select" id="patternSourcenameSelect" name="sourcename">
                            {% for source in sources %}
                            <option {% if source == source_name %}selected{% endif %}>{{ source }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="my-3">
                        <label for="patternInput" class="form-label">Enter pattern</label>
                        <a data-bs-toggle="collapse"
                            href="#structured-help-text"
                            aria-controls="structured-help-text"
                            aria-expanded="false">
                            {{ bootstrap_icon('question-circle') }}
                        </a>

                        <div class="row">
                            <div class="col-md-4">
                                <select class="form-select" id="patternKeySelect" name="patternkey" required>
                                    <optgroup label="Tags">
                                        {% for tag_key in tag_keys %}
                                        {% if selectedpatternkey is not none %}
                                        <option {% if tag_key == selectedpatternkey %}selected{% endif %} value="tag:{{ tag_key }}">{{ tag_key|capitalize }}</option>
                                        {% else %}
                                        <option {% if tag_key == "series name" %}selected{% endif %} value="tag:{{ tag_key }}">{{ tag_key|capitalize }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </optgroup>
                                    {% if metadata_fields|length > 0  %}
                                    <optgroup label="Metadata">
                                        {% for metadata_field in metadata_fields %}
                                        <option {% if metadata_field == selectedpatternkey %}selected{% endif %} value="metadata:{{ metadata_field }}">{{ metadata_field|capitalize }}</option>
                                        {% endfor %}
                                    </optgroup>
                                    {% endif %}
                                </select>
                            </div>
                            <div class="col">
                                <input type="text"
                                       class="form-control"
                                       id="patternInput"
                                       name="pattern"
                                       value="{{ pattern or '' }}"
                                       autocomplete="off"
                                       placeholder="Pattern"
                                       required>
                            </div>
                        </div>
                    </div>

                    <div class="my-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="structured" id="structured" {% if is_structured %}checked{% endif %}>
                            <label for="structured" class="form-check-label">Structured</label>
                        </div>
                    </div>

                    <div class="collapse form-text" id="structured-help-text">
                        <p>
                            Time series are found by searching for a text pattern in a given pattern key (tag key or metadata field).
                            This pattern can occur at any position in the selected pattern key, case insensitive.
                        </p>
                        <p>
                            For example, with the <code>Series name</code> tag selected:
                        </p>
                        <p>

                            By using <code>*</code>, it is possible to search for simple patterns.
                            <code>*.PV</code> searches for all series that end on <code>.PV</code>.
                            <code>10_*</code> searches for all series that start with <code>10_</code>.
                            <code>10_*.PV</code> searches for all series that start with <code>10_</code> and end on <code>.PV</code>.
                        </p>
                        <p>
                            When the 'Structured' checkbox is enabled the pattern is a <a href="https://docs.python.org/3/library/re.html#regular-expression-syntax">regular expression</a>.
                            The <code>10_1234\d{2}\.((PV)|(SP))$</code> regular expression selects all <code>PV</code>s and <code>SP</code>s that are part of <code>10_1234</code> and are themselves identified by 2 numbers (<code>\d{2}</code>).
                        </p>
                    </div>


                    <div class="my-3">
                        {% if not new_series %}
                        <button type="submit" class="btn btn-primary">Preview</button>
                        {% else %}
                        <button type="submit" class="btn btn-secondary">Preview</button>
                        {% endif %}

                        {% if new_series %}
                        <div class="btn-group ts-dropdown-select-button">
                            <a class="btn btn-primary dropdown-toggle"
                               href="#"
                               role="button"
                               id="selectionDropdown"
                               data-bs-toggle="dropdown"
                               aria-haspopup="true"
                               aria-expanded="false">
                            </a>
                            <div class="dropdown-menu" aria-labelledby="selectionDropdown">
                                <button type="submit"
                                        class="dropdown-item ts-dropdown-action"
                                        form="seriesselection"
                                        formaction="{{ url_for('.add_series') }}"
                                        >
                                        Add all series
                                </button>
                                <button type="submit"
                                        class="dropdown-item ts-dropdown-action"
                                        form="seriesselection"
                                        formaction="{{ url_for('.add_pattern') }}"
                                        >
                                        Add pattern
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </form>

                {% if new_series %}
                <p>
                    {{ new_series|count }} series found.
                </p>

                <form id='seriesselection' method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="seriessetname" value="{{ series_set.name }}">
                    <input type="hidden" name="sourcename" value="{{ source_name }}">
                    <input type="hidden" name="seriespattern" value="{{ pattern }}">
                    <input type="hidden" name="patternkey" value="{{ selectedpatternkey }}">
                    <input type="hidden" name="patternkeytype" value="{{ selectedpatternkeytype }}">
                    {% if is_structured %}
                    <input type="hidden" name="structured" value="on">
                    {% endif %}

                    <table class="ts-table ts-table-checkbox table table-borderless series-table" data-ts-target="selectionDropdown">
                        <thead class="thead-secondary">
                            <tr class="border-top border-bottom">
                                <th scope="col">
                                    <input class="form-check-input" type="checkbox">
                                </th>
                                <th scope="col">Series name</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for series in new_series|sort(attribute='name') %}
                            <tr class="border-bottom">
                                <td>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="seriesinclude-{{ loop.index0 }}" checked>
                                    </div>
                                </td>
                                <td class="align-middle">
                                    <a class="ts-series-details ts-table-link text-decoration-none text-dark"
                                        data-series-url="{{ url_for('metadata.get_metadata', seriesid=series.series_id) }}"
                                        href="#">
                                        {{ visualize_series(series) }}
                                    </a>
                                    <input type="hidden" name="seriesid" value="{{ series.series_id }}">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </form>
                {% elif pattern %}
                <p>No series found.</p>
                {% endif %}

            </div>

            <div class="tab-pane {% if validating_time_series %}show active{% endif %}" id="bulkAddPanel" role="tabpanel" aria-labelledby="bulkAddTabLabel">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="seriessetname" value="{{ series_set.name }}">

                    <div class="my-3">
                        <label for="bulkSourcenameSelect" class="form-label">Select time series source</label>
                        <select class="form-select" id="bulkSourcenameSelect" name="sourcename">
                            {% for source in sources %}
                            <option {% if source == source_name %}selected{% endif %}>{{ source }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="my-3">
                        <label for="bulkInput" class="form-label">Provide time series names</label>
                        <textarea id="bulkInput"
                                    class="form-control"
                                    name="seriesnames"
                                    rows="10"
                                    placeholder="SINUSOID
SINUSOIDU
ATCAI"
                                    required>{{ series_names }}</textarea>
                        <div class="form-text">
                            Enter one time series name per line.
                        </div>
                    </div>

                    <div class="form-check form-check-inline">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="validateseries"
                            name="validateseries"
                            checked>
                        <label for="validateseries" class="form-check-label">Validate time series</label>
                    </div>

                    <div class="my-3">
                        {% if validating_time_series is none or validating_time_series %}
                        {% if existing_series|count > 0 %}
                        <button id="bulkseriesaction" type="submit" class="btn btn-secondary">Validate series</button>
                        {% else %}
                        <button id="bulkseriesaction" type="submit" class="btn btn-primary">Validate series</button>
                        {% endif %}
                        {% else %}
                        <button id="bulkseriesaction" type="submit" class="btn btn-primary">Add series</button>
                        {% endif %}

                        {% if validating_time_series and existing_series|count > 0 %}
                        <div id="addvalidbulkseries" class="btn-group ts-dropdown-select-button">
                            <a class="btn btn-primary dropdown-toggle"
                            href="#"
                            role="button"
                            id="selectionDropdown"
                            data-bs-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false"></a>
                            <div class="dropdown-menu" aria-labelledby="selectionDropdown">
                                <button type="submit"
                                    class="dropdown-item ts-dropdown-action"
                                    form="bulkseriesinclusion"
                                    formaction="{{ url_for('.add_series_in_bulk') }}"
                                    >
                                    Add series
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </form>


                {% if validating_time_series %}
                {% if existing_series|count > 0 %}
                <form id='bulkseriesinclusion' method="POST">
                    <p>{{ existing_series|count }} series found.</p>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="seriessetname" value="{{ series_set.name }}">
                    <input type="hidden" name="sourcename" value="{{ source_name }}">
                    <table class="ts-table ts-table-checkbox table table-borderless series-table" data-ts-target="selectionDropdown">
                        <thead class="thead-secondary">
                            <tr class="border-top border-bottom">
                                <th scope="col">
                                    <input class="form-check-input" type="checkbox">
                                </th>
                                <th scope="col">Series name</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for series in existing_series|sort(attribute='name') %}
                            <tr class="border-bottom">
                                <td>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="seriesinclude-{{ loop.index0 }}" checked>
                                    </div>
                                </td>
                                <td class="align-middle">
                                    <a class="ts-series-details ts-table-link text-decoration-none text-dark"
                                        data-series-url="{{ url_for('metadata.get_metadata', seriesid=series.series_id) }}"
                                        href="#">
                                        {{ visualize_series(series) }}
                                    </a>
                                    <input type="hidden" name="seriesid" value="{{ series.series_id }}">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </form>
                {% else %}
                <p id="novalidseriesindicator" class="my-3">No series found.</p>
                {% endif %}
                {% endif %}

                {% if missing_series|count > 0 %}
                <div id="missingseries" class="my-3">
                    <h6>
                        Missing series
                        {{ info_popover('Series that could not be found in the selected source.') }}
                    </h6>
                    <ul>
                        {% for series_name in missing_series|sort %}
                        <li>{{ series_name }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="pt-3 my-3">
    {{ alerter() }}

    {% if series_patterns %}
    {% if series_set.origin.value == 'ui' %}
    <div class="mb-3">
        <div class="btn-group ts-dropdown-select-button">
            <a class="btn border border-secondary dropdown-toggle"
            href="#"
            role="button"
            id="patternSelectionDropdown"
            data-bs-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false">
            </a>
            <div class="dropdown-menu" aria-labelledby="patternSelectionDropdown">
                <button type="submit"
                        class="dropdown-item ts-dropdown-action"
                        form="patternSelection"
                        >
                        Remove selected
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <form id="patternSelection" method="POST" action="{{ url_for('.remove_patterns', sourcename=source_name) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="seriessetname" value="{{ series_set.name }}">
        <table class="ts-table {% if series_set.origin.value == 'ui' %}ts-table-checkbox{% endif %} table table-borderless pattern-table mb-3" data-ts-target="patternSelectionDropdown">
            <thead class="thead-secondary">
                <tr class="border-top border-bottom">
                    {% if series_set.origin.value == 'ui' %}
                    <th scope="col" class="table-check">
                        <input class="form-check-input" type="checkbox">
                    </th>
                    {% endif %}
                    <th scope="col">Source name</th>
                    <th scope="col">Name</th>
                    <th scope="col">Pattern</th>
                    <th scope="col">Field pattern</th>
                </tr>
            </thead>
            <tbody>
                {% for pattern in series_patterns|sort(attribute='source_name') %}
                {% set outer_loop = loop %}
                {% set ns = namespace(first_row_added=false) %}
                {% for pattern_key, pattern_value in pattern.tag_patterns|dictsort %}
                <tr class="border-bottom">
                    {% if loop.first and not ns.first_row_added%}
                    {% if series_set.origin.value == 'ui' %}
                    <td rowspan="{{ (pattern.tag_patterns|count)+(pattern.metadata_patterns|count) }}">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="removepattern" value="{{ outer_loop.index0 }}">
                        </div>
                    </td>
                    {% endif %}
                    <td rowspan="{{ (pattern.tag_patterns|count)+(pattern.metadata_patterns|count) }}">
                        <input type="hidden" name="sourcename" value="{{ pattern.source_name }}">
                        <span>{{ pattern.source_name }}</span>
                    </td>
                    {% endif %}
                    <td class="align-middle">
                        <input type="hidden" name="pattern_key" value="{{ pattern_key }}">
                        <span>{{ pattern_key }}</span>
                    </td>
                    <td class="align-middle">
                        <input type="hidden" name="pattern_value" value="{{ pattern_value }}">
                        <span>{{ pattern_value }}</span>
                    </td>
                    {% if loop.first and not ns.first_row_added %}
                    {% set ns.first_row_added = true %}
                    <td rowspan="{{ (pattern.tag_patterns|count)+(pattern.metadata_patterns|count) }}">
                        <input type="hidden" name="field_pattern" value="{{ pattern.field_pattern }}">
                        <span>{{ pattern.field_pattern }}</span>
                    </td>
                    {% endif %}
                    </tr>
                    {% endfor %}
                    {% for field_name, field_value in pattern.metadata_patterns|dictsort %}
                    <tr class="border-bottom">
                    {% if loop.first and not ns.first_row_added%}
                    {% if series_set.origin.value == 'ui' %}
                    <td rowspan="{{ (pattern.tag_patterns|count)+(pattern.metadata_patterns|count) }}">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="removepattern" value="{{ outer_loop.index0 }}">
                        </div>
                    </td>
                    {% endif %}
                    <td rowspan="{{ (pattern.tag_patterns|count)+(pattern.metadata_patterns|count) }}">
                        <input type="hidden" name="sourcename" value="{{ pattern.source_name }}">
                        <span>{{ pattern.source_name }}</span>
                    </td>
                    {% endif %}
                      <td class="align-middle">
                          <input type="hidden" name="field_name" value="{{ field_name }}">
                          <span>{{ field_name }}</span>
                      </td>
                      <td class="align-middle">
                          <input type="hidden" name="field_value" value="{{ field_value }}">
                          <span>{{ field_value }}</span>
                      </td>
                      {% if loop.first and not ns.first_row_added %}
                      {% set ns.first_row_added = true %}
                      <td rowspan="{{ (pattern.tag_patterns|count)+(pattern.metadata_patterns|count) }}">
                        <input type="hidden" name="field_pattern" value="{{ pattern.field_pattern }}">
                        <span>{{ pattern.field_pattern }}</span>
                      </td>
                      {% endif %}
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </form>
    {% endif %}

    {% if all_series|count > 0 %}
    {% if individual_series|count > 0 %}
    <div class="mb-3">
        <div class="btn-group ts-dropdown-select-button">
            <a class="btn border border-secondary dropdown-toggle"
            href="#"
            role="button"
            id="seriesSelectionDropdown"
            data-bs-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false">
            </a>
            <div class="dropdown-menu" aria-labelledby="seriesSelectionDropdown">
                <button type="submit"
                        class="dropdown-item ts-dropdown-action"
                        form="seriesOverview"
                        >
                        Remove selected
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <form id="seriesOverview" method="POST" action="{{ url_for('.remove_series', sourcename=source_name) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="seriessetname" value="{{ series_set.name }}">
        <table class="ts-table ts-table-checkbox table table-borderless series-table mt-3" data-ts-target="seriesSelectionDropdown">
            <thead class="thead-secondary">
                <tr class="border-top border-bottom">
                    {% if individual_series|count > 0 %}
                    <th scope="col" class="table-check">
                        <input class="form-check-input" type="checkbox">
                    </th>
                    {% endif %}
                    <th scope="col">Series name</th>
                </tr>
            </thead>
            <tbody>
                {% for series in all_series|sort(attribute='name,source') %}
                <tr class="border-bottom" data-ts-series-source="{{ series.source }}" data-ts-series-name="{{ series.name }}">
                    {% if individual_series|count > 0 %}
                    <td class="align-middle">
                        {% if series in individual_series %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="seriesid" value="{{ series.series_id }}">
                        </div>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td class="align-middle">
                        <a class="ts-series-details ts-table-link text-decoration-none text-dark"
                            data-series-url="{{ url_for('metadata.get_metadata', seriesid=series.series_id) }}"
                            href="#">
                            {{ visualize_series(series) }}
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
    {% else %}
    <p class="alert alert-info">
        Series set empty.
    </p>
    {% endif %}
</div>

<script src="{{ url_for('static', filename='dist/autocomplete.js') }}" nonce="{{ csp_nonce }}"></script>
<script nonce="{{ csp_nonce }}">
    (function () {
        var existingSeries = [];
        for (const series of document.querySelectorAll('[data-ts-series-name]')) {
            existingSeries.push({source: series.getAttribute('data-ts-series-source'), name: series.getAttribute('data-ts-series-name')});
        }

        $('#seriesnameInput').autoComplete({
            bootstrapVersion: '4',
            minLength: 1,
            noResultsText: 'No matching series known.',
            resolver: 'custom',
            formatResult: AutoComplete.formatSeries,
            events: {
                search: function (pattern, callback) {
                    var sourceName = $('#sourcenameSelect').val();
                    var params = {
                        'source': sourceName,
                        'pattern': pattern,
                        'page': 0,
                        'pageSize': 100,
                    };
                    $.ajax('{{ url_for("api.search_series_names") }}', {data: params})
                    .done(function(data) {
                        var seriesInSource = existingSeries
                            .filter(function (series) {return series.source === sourceName;})
                            .map(function (series) {return series.name;});
                        callback(data.filter(function (series) {return !seriesInSource.includes(series.name);}));
                    });
                },
            },
        });
    })();
    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function buildOptGroup(label, prefix, keyList) {
      return $("<optgroup></optgroup>")
          .attr("label", label)
          .append(keyList.map(function(tagKey) {
              return $("<option></option>").attr("value", `${prefix}:${tagKey}`).text(capitalize(tagKey));
          })
      );

    }

    (function () {
        $("#patternSourcenameSelect").on('change', function(event) {
            const sourcename = event.target.value;
            const searchParams = new URLSearchParams(window.location.search);
            searchParams.set("sourcename", sourcename);
            const newRelativePathQuery = `${window.location.pathname}?${searchParams.toString()}`;
            history.pushState(null, '', newRelativePathQuery);
            $.ajax( '{{ url_for("api.get_tags_keys_and_metadata_fields") }}', {data: {sourcename}})
            .done(function(data) {
                const select = $("#patternKeySelect").empty();
                const tagOptGroup = buildOptGroup("Tags", "tag", data.tagKeys);
                const metadataOptGroup = buildOptGroup("Metadata", "metadata", data.metadataFields);
                select.append([tagOptGroup, metadataOptGroup]);
            });
        });

        $("#validateseries").on('change', function(event) {
            if (event.target.checked) {
                $("#bulkseriesaction").html("Validate series")
                {% if validating_time_series and existing_series|count>0 %}
                $("#bulkseriesaction").removeClass('btn-primary').addClass('btn-secondary')
                {% endif %}
                $("#bulkseriesinclusion, #addvalidbulkseries, #missingseries, #novalidseriesindicator").show()
            }
            else {
                $("#bulkseriesaction").html("Add series")
                $("#bulkseriesaction").removeClass('btn-secondary').addClass('btn-primary')
                $("#bulkseriesinclusion, #addvalidbulkseries, #missingseries, #novalidseriesindicator").hide()
            }
        });
    })()
    </script>
{% endblock %}
